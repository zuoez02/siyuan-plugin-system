(function(){var _a,_b,_c;const path$3=require("path"),log=(...t)=>{console.log("[Plugin System] ",...t)},error=(...t)=>console.error("[Plugin System] ",...t),reloadWindow=()=>window.location.reload(),getCrossPlatformAppDataFolder=()=>{let t;return"darwin"===process.platform?t=path$3.join(PROCESS_ENV.HOME,"/Library/Application Support"):"win32"===process.platform?t=PROCESS_ENV.APPDATA:"linux"===process.platform&&(t=PROCESS_ENV.HOME),t},genUUID=()=>([1e7].toString()+-1e3+-4e3+-8e3+-1e11).replace(/[018]/g,(t=>(parseInt(t,10)^window.crypto.getRandomValues(new Uint32Array(1))[0]&15>>parseInt(t,10)/4).toString(16))),path$2=require("path"),PROCESS_ENV=window.process.env,SIYUAN_DATA_PATH=window.siyuan.config.system.dataDir,PLUGIN_FOLDER="plugins",VERSION="v0.3.2",VERSION_URL="https://gitee.com/zuoez02/siyuan-plugin-system/raw/main/VERSION",SCRIPT_URL="https://gitee.com/zuoez02/siyuan-plugin-system/raw/main/main.js",PLUGIN_SYS_ABS_PATH=path$2.join(getCrossPlatformAppDataFolder(),".siyuan","plugin.js"),config=()=>({token:window.siyuan.config.api.token});var NAMED_TAG="named",NAME_TAG="name",UNMANAGED_TAG="unmanaged",OPTIONAL_TAG="optional",INJECT_TAG="inject",MULTI_INJECT_TAG="multi_inject",TAGGED="inversify:tagged",TAGGED_PROP="inversify:tagged_props",PARAM_TYPES="inversify:paramtypes",DESIGN_PARAM_TYPES="design:paramtypes",POST_CONSTRUCT="post_construct",PRE_DESTROY="pre_destroy";function getNonCustomTagKeys(){return[INJECT_TAG,MULTI_INJECT_TAG,NAME_TAG,UNMANAGED_TAG,NAMED_TAG,OPTIONAL_TAG]}var NON_CUSTOM_TAG_KEYS=getNonCustomTagKeys(),BindingScopeEnum={Request:"Request",Singleton:"Singleton",Transient:"Transient"},BindingTypeEnum={ConstantValue:"ConstantValue",Constructor:"Constructor",DynamicValue:"DynamicValue",Factory:"Factory",Function:"Function",Instance:"Instance",Invalid:"Invalid",Provider:"Provider"},TargetTypeEnum={ClassProperty:"ClassProperty",ConstructorArgument:"ConstructorArgument",Variable:"Variable"},idCounter=0;function id(){return idCounter++}var Binding=function(){function t(t,e){this.id=id(),this.activated=!1,this.serviceIdentifier=t,this.scope=e,this.type=BindingTypeEnum.Invalid,this.constraint=function(t){return!0},this.implementationType=null,this.cache=null,this.factory=null,this.provider=null,this.onActivation=null,this.onDeactivation=null,this.dynamicValue=null}return t.prototype.clone=function(){var e=new t(this.serviceIdentifier,this.scope);return e.activated=e.scope===BindingScopeEnum.Singleton&&this.activated,e.implementationType=this.implementationType,e.dynamicValue=this.dynamicValue,e.scope=this.scope,e.type=this.type,e.factory=this.factory,e.provider=this.provider,e.constraint=this.constraint,e.onActivation=this.onActivation,e.onDeactivation=this.onDeactivation,e.cache=this.cache,e},t}(),DUPLICATED_INJECTABLE_DECORATOR="Cannot apply @injectable decorator multiple times.",DUPLICATED_METADATA="Metadata key was used more than once in a parameter:",NULL_ARGUMENT="NULL argument",KEY_NOT_FOUND="Key Not Found",AMBIGUOUS_MATCH="Ambiguous match found for serviceIdentifier:",CANNOT_UNBIND="Could not unbind serviceIdentifier:",NOT_REGISTERED="No matching bindings found for serviceIdentifier:",MISSING_INJECTABLE_ANNOTATION="Missing required @injectable annotation in:",MISSING_INJECT_ANNOTATION="Missing required @inject or @multiInject annotation in:",UNDEFINED_INJECT_ANNOTATION=function(t){return"@inject called with undefined this could mean that the class "+t+" has a circular dependency problem. You can use a LazyServiceIdentifer to  overcome this limitation."},CIRCULAR_DEPENDENCY="Circular dependency found:",INVALID_BINDING_TYPE="Invalid binding type:",NO_MORE_SNAPSHOTS_AVAILABLE="No snapshot available to restore.",INVALID_MIDDLEWARE_RETURN="Invalid return type in middleware. Middleware must return!",INVALID_FUNCTION_BINDING="Value provided to function binding must be a function!",LAZY_IN_SYNC=function(t){return"You are attempting to construct '"+t+"' in a synchronous way\n but it has asynchronous dependencies."},INVALID_TO_SELF_VALUE="The toSelf function can only be applied when a constructor is used as service identifier",INVALID_DECORATOR_OPERATION="The @inject @multiInject @tagged and @named decorators must be applied to the parameters of a class constructor or a class property.",ARGUMENTS_LENGTH_MISMATCH=function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];return"The number of constructor arguments in the derived class "+t[0]+" must be >= than the number of constructor arguments of its base class."},CONTAINER_OPTIONS_MUST_BE_AN_OBJECT="Invalid Container constructor argument. Container options must be an object.",CONTAINER_OPTIONS_INVALID_DEFAULT_SCOPE="Invalid Container option. Default scope must be a string ('singleton' or 'transient').",CONTAINER_OPTIONS_INVALID_AUTO_BIND_INJECTABLE="Invalid Container option. Auto bind injectable must be a boolean",CONTAINER_OPTIONS_INVALID_SKIP_BASE_CHECK="Invalid Container option. Skip base check must be a boolean",ASYNC_UNBIND_REQUIRED="Attempting to unbind dependency with asynchronous destruction (@preDestroy or onDeactivation)",POST_CONSTRUCT_ERROR=function(t,e){return"@postConstruct error in class "+t+": "+e},PRE_DESTROY_ERROR=function(t,e){return"@preDestroy error in class "+t+": "+e},ON_DEACTIVATION_ERROR=function(t,e){return"onDeactivation() error in class "+t+": "+e},CIRCULAR_DEPENDENCY_IN_FACTORY=function(t,e){return"It looks like there is a circular dependency in one of the '"+t+"' bindings. Please investigate bindings withservice identifier '"+e+"'."},STACK_OVERFLOW="Maximum call stack size exceeded",MetadataReader=function(){function t(){}return t.prototype.getConstructorMetadata=function(t){return{compilerGeneratedMetadata:Reflect.getMetadata(PARAM_TYPES,t),userGeneratedMetadata:Reflect.getMetadata(TAGGED,t)||{}}},t.prototype.getPropertiesMetadata=function(t){return Reflect.getMetadata(TAGGED_PROP,t)||[]},t}(),BindingCount={MultipleBindingsAvailable:2,NoBindingsAvailable:0,OnlyOneBindingAvailable:1};function isStackOverflowExeption(t){return t instanceof RangeError||t.message===STACK_OVERFLOW}var tryAndThrowErrorIfStackOverflow=function(t,e){try{return t()}catch(n){throw isStackOverflowExeption(n)&&(n=e()),n}};function getServiceIdentifierAsString(t){return"function"==typeof t?t.name:"symbol"==typeof t?t.toString():t}function listRegisteredBindingsForServiceIdentifier(t,e,n){var r="",i=n(t,e);return 0!==i.length&&(r="\nRegistered bindings:",i.forEach((function(t){var e="Object";null!==t.implementationType&&(e=getFunctionName(t.implementationType)),r=r+"\n "+e,t.constraint.metaData&&(r=r+" - "+t.constraint.metaData)}))),r}function alreadyDependencyChain(t,e){return null!==t.parentRequest&&(t.parentRequest.serviceIdentifier===e||alreadyDependencyChain(t.parentRequest,e))}function dependencyChainToString(t){var e=function t(e,n){void 0===n&&(n=[]);var r=getServiceIdentifierAsString(e.serviceIdentifier);return n.push(r),null!==e.parentRequest?t(e.parentRequest,n):n}(t);return e.reverse().join(" --\x3e ")}function circularDependencyToException(t){t.childRequests.forEach((function(t){if(alreadyDependencyChain(t,t.serviceIdentifier)){var e=dependencyChainToString(t);throw new Error(CIRCULAR_DEPENDENCY+" "+e)}circularDependencyToException(t)}))}function listMetadataForTarget(t,e){if(e.isTagged()||e.isNamed()){var n="",r=e.getNamedTag(),i=e.getCustomTags();return null!==r&&(n+=r.toString()+"\n"),null!==i&&i.forEach((function(t){n+=t.toString()+"\n"}))," "+t+"\n "+t+" - "+n}return" "+t}function getFunctionName(t){if(t.name)return t.name;var e=t.toString(),n=e.match(/^function\s*([^\s(]+)/);return n?n[1]:"Anonymous function: "+e}function getSymbolDescription(t){return t.toString().slice(7,-1)}var Context=function(){function t(t){this.id=id(),this.container=t}return t.prototype.addPlan=function(t){this.plan=t},t.prototype.setCurrentRequest=function(t){this.currentRequest=t},t}(),Metadata=function(){function t(t,e){this.key=t,this.value=e}return t.prototype.toString=function(){return this.key===NAMED_TAG?"named: "+String(this.value).toString()+" ":"tagged: { key:"+this.key.toString()+", value: "+String(this.value)+" }"},t}(),Plan=function(t,e){this.parentContext=t,this.rootRequest=e},LazyServiceIdentifer=function(){function t(t){this._cb=t}return t.prototype.unwrap=function(){return this._cb()},t}(),QueryableString=function(){function t(t){this.str=t}return t.prototype.startsWith=function(t){return 0===this.str.indexOf(t)},t.prototype.endsWith=function(t){var e,n=t.split("").reverse().join("");return e=this.str.split("").reverse().join(""),this.startsWith.call({str:e},n)},t.prototype.contains=function(t){return-1!==this.str.indexOf(t)},t.prototype.equals=function(t){return this.str===t},t.prototype.value=function(){return this.str},t}(),Target=function(){function t(t,e,n,r){this.id=id(),this.type=t,this.serviceIdentifier=n;var i="symbol"==typeof e?getSymbolDescription(e):e;this.name=new QueryableString(i||""),this.identifier=e,this.metadata=new Array;var o=null;"string"==typeof r?o=new Metadata(NAMED_TAG,r):r instanceof Metadata&&(o=r),null!==o&&this.metadata.push(o)}return t.prototype.hasTag=function(t){for(var e=0,n=this.metadata;e<n.length;e++){if(n[e].key===t)return!0}return!1},t.prototype.isArray=function(){return this.hasTag(MULTI_INJECT_TAG)},t.prototype.matchesArray=function(t){return this.matchesTag(MULTI_INJECT_TAG)(t)},t.prototype.isNamed=function(){return this.hasTag(NAMED_TAG)},t.prototype.isTagged=function(){return this.metadata.some((function(t){return NON_CUSTOM_TAG_KEYS.every((function(e){return t.key!==e}))}))},t.prototype.isOptional=function(){return this.matchesTag(OPTIONAL_TAG)(!0)},t.prototype.getNamedTag=function(){return this.isNamed()?this.metadata.filter((function(t){return t.key===NAMED_TAG}))[0]:null},t.prototype.getCustomTags=function(){return this.isTagged()?this.metadata.filter((function(t){return NON_CUSTOM_TAG_KEYS.every((function(e){return t.key!==e}))})):null},t.prototype.matchesNamedTag=function(t){return this.matchesTag(NAMED_TAG)(t)},t.prototype.matchesTag=function(t){var e=this;return function(n){for(var r=0,i=e.metadata;r<i.length;r++){var o=i[r];if(o.key===t&&o.value===n)return!0}return!1}},t}(),__spreadArray$2=globalThis&&globalThis.__spreadArray||function(t,e,n){if(n||2===arguments.length)for(var r,i=0,o=e.length;i<o;i++)!r&&i in e||(r||(r=Array.prototype.slice.call(e,0,i)),r[i]=e[i]);return t.concat(r||Array.prototype.slice.call(e))};function getDependencies(t,e){return getTargets(t,getFunctionName(e),e,!1)}function getTargets(t,e,n,r){var i=t.getConstructorMetadata(n),o=i.compilerGeneratedMetadata;if(void 0===o)throw new Error(MISSING_INJECTABLE_ANNOTATION+" "+e+".");var a=i.userGeneratedMetadata,s=Object.keys(a),c=0===n.length&&s.length>0,u=s.length>n.length,l=getConstructorArgsAsTargets(r,e,o,a,c||u?s.length:n.length),d=getClassPropsAsTargets(t,n,e);return __spreadArray$2(__spreadArray$2([],l,!0),d,!0)}function getConstructorArgsAsTarget(t,e,n,r,i){var o=i[t.toString()]||[],a=formatTargetMetadata(o),s=!0!==a.unmanaged,c=r[t],u=a.inject||a.multiInject;if((c=u||c)instanceof LazyServiceIdentifer&&(c=c.unwrap()),s){if(!e&&(c===Object||c===Function||void 0===c))throw new Error(MISSING_INJECT_ANNOTATION+" argument "+t+" in class "+n+".");var l=new Target(TargetTypeEnum.ConstructorArgument,a.targetName,c);return l.metadata=o,l}return null}function getConstructorArgsAsTargets(t,e,n,r,i){for(var o=[],a=0;a<i;a++){var s=getConstructorArgsAsTarget(a,t,e,n,r);null!==s&&o.push(s)}return o}function _getServiceIdentifierForProperty(t,e,n,r){var i=t||e;if(void 0===i){var o=MISSING_INJECTABLE_ANNOTATION+" for property "+String(n)+" in class "+r+".";throw new Error(o)}return i}function getClassPropsAsTargets(t,e,n){for(var r=t.getPropertiesMetadata(e),i=[],o=Object.getOwnPropertySymbols(r),a=0,s=Object.keys(r).concat(o);a<s.length;a++){var c=s[a],u=r[c],l=formatTargetMetadata(u),d=l.targetName||c,p=_getServiceIdentifierForProperty(l.inject,l.multiInject,c,n),f=new Target(TargetTypeEnum.ClassProperty,d,p);f.metadata=u,i.push(f)}var h=Object.getPrototypeOf(e.prototype).constructor;if(h!==Object){var g=getClassPropsAsTargets(t,h,n);i=__spreadArray$2(__spreadArray$2([],i,!0),g,!0)}return i}function getBaseClassDependencyCount(t,e){var n=Object.getPrototypeOf(e.prototype).constructor;if(n!==Object){var r=getTargets(t,getFunctionName(n),n,!0),i=r.map((function(t){return t.metadata.filter((function(t){return t.key===UNMANAGED_TAG}))})),o=[].concat.apply([],i).length,a=r.length-o;return a>0?a:getBaseClassDependencyCount(t,n)}return 0}function formatTargetMetadata(t){var e={};return t.forEach((function(t){e[t.key.toString()]=t.value})),{inject:e[INJECT_TAG],multiInject:e[MULTI_INJECT_TAG],targetName:e[NAME_TAG],unmanaged:e[UNMANAGED_TAG]}}var Request=function(){function t(t,e,n,r,i){this.id=id(),this.serviceIdentifier=t,this.parentContext=e,this.parentRequest=n,this.target=i,this.childRequests=[],this.bindings=Array.isArray(r)?r:[r],this.requestScope=null===n?new Map:null}return t.prototype.addChildRequest=function(e,n,r){var i=new t(e,this.parentContext,this,n,r);return this.childRequests.push(i),i},t}();function getBindingDictionary(t){return t._bindingDictionary}function _createTarget(t,e,n,r,i,o){var a=new Metadata(t?MULTI_INJECT_TAG:INJECT_TAG,n),s=new Target(e,r,n,a);if(void 0!==i){var c=new Metadata(i,o);s.metadata.push(c)}return s}function _getActiveBindings(t,e,n,r,i){var o=getBindings(n.container,i.serviceIdentifier),a=[];return o.length===BindingCount.NoBindingsAvailable&&n.container.options.autoBindInjectable&&"function"==typeof i.serviceIdentifier&&t.getConstructorMetadata(i.serviceIdentifier).compilerGeneratedMetadata&&(n.container.bind(i.serviceIdentifier).toSelf(),o=getBindings(n.container,i.serviceIdentifier)),a=e?o:o.filter((function(t){var e=new Request(t.serviceIdentifier,n,r,t,i);return t.constraint(e)})),_validateActiveBindingCount(i.serviceIdentifier,a,i,n.container),a}function _validateActiveBindingCount(t,e,n,r){switch(e.length){case BindingCount.NoBindingsAvailable:if(n.isOptional())return e;var i=getServiceIdentifierAsString(t),o=NOT_REGISTERED;throw o+=listMetadataForTarget(i,n),o+=listRegisteredBindingsForServiceIdentifier(r,i,getBindings),new Error(o);case BindingCount.OnlyOneBindingAvailable:return e;case BindingCount.MultipleBindingsAvailable:default:if(n.isArray())return e;i=getServiceIdentifierAsString(t),o=AMBIGUOUS_MATCH+" "+i;throw o+=listRegisteredBindingsForServiceIdentifier(r,i,getBindings),new Error(o)}}function _createSubRequests(t,e,n,r,i,o){var a,s;if(null===i){a=_getActiveBindings(t,e,r,null,o),s=new Request(n,r,null,a,o);var c=new Plan(r,s);r.addPlan(c)}else a=_getActiveBindings(t,e,r,i,o),s=i.addChildRequest(o.serviceIdentifier,a,o);a.forEach((function(e){var n=null;if(o.isArray())n=s.addChildRequest(e.serviceIdentifier,e,o);else{if(e.cache)return;n=s}if(e.type===BindingTypeEnum.Instance&&null!==e.implementationType){var i=getDependencies(t,e.implementationType);if(!r.container.options.skipBaseClassChecks){var a=getBaseClassDependencyCount(t,e.implementationType);if(i.length<a){var c=ARGUMENTS_LENGTH_MISMATCH(getFunctionName(e.implementationType));throw new Error(c)}}i.forEach((function(e){_createSubRequests(t,!1,e.serviceIdentifier,r,n,e)}))}}))}function getBindings(t,e){var n=[],r=getBindingDictionary(t);return r.hasKey(e)?n=r.get(e):null!==t.parent&&(n=getBindings(t.parent,e)),n}function plan(t,e,n,r,i,o,a,s){void 0===s&&(s=!1);var c=new Context(e),u=_createTarget(n,r,i,"",o,a);try{return _createSubRequests(t,s,i,c,null,u),c}catch(l){throw isStackOverflowExeption(l)&&circularDependencyToException(c.plan.rootRequest),l}}function createMockRequest(t,e,n,r){var i=new Target(TargetTypeEnum.Variable,"",e,new Metadata(n,r)),o=new Context(t);return new Request(e,o,null,[],i)}function isPromise(t){return("object"==typeof t&&null!==t||"function"==typeof t)&&"function"==typeof t.then}function isPromiseOrContainsPromise(t){return!!isPromise(t)||Array.isArray(t)&&t.some(isPromise)}var __awaiter$3=globalThis&&globalThis.__awaiter||function(t,e,n,r){return new(n||(n=Promise))((function(i,o){function a(t){try{c(r.next(t))}catch(e){o(e)}}function s(t){try{c(r.throw(t))}catch(e){o(e)}}function c(t){var e;t.done?i(t.value):(e=t.value,e instanceof n?e:new n((function(t){t(e)}))).then(a,s)}c((r=r.apply(t,e||[])).next())}))},__generator$3=globalThis&&globalThis.__generator||function(t,e){var n,r,i,o,a={label:0,sent:function(){if(1&i[0])throw i[1];return i[1]},trys:[],ops:[]};return o={next:s(0),throw:s(1),return:s(2)},"function"==typeof Symbol&&(o[Symbol.iterator]=function(){return this}),o;function s(o){return function(s){return function(o){if(n)throw new TypeError("Generator is already executing.");for(;a;)try{if(n=1,r&&(i=2&o[0]?r.return:o[0]?r.throw||((i=r.return)&&i.call(r),0):r.next)&&!(i=i.call(r,o[1])).done)return i;switch(r=0,i&&(o=[2&o[0],i.value]),o[0]){case 0:case 1:i=o;break;case 4:return a.label++,{value:o[1],done:!1};case 5:a.label++,r=o[1],o=[0];continue;case 7:o=a.ops.pop(),a.trys.pop();continue;default:if(!(i=a.trys,(i=i.length>0&&i[i.length-1])||6!==o[0]&&2!==o[0])){a=0;continue}if(3===o[0]&&(!i||o[1]>i[0]&&o[1]<i[3])){a.label=o[1];break}if(6===o[0]&&a.label<i[1]){a.label=i[1],i=o;break}if(i&&a.label<i[2]){a.label=i[2],a.ops.push(o);break}i[2]&&a.ops.pop(),a.trys.pop();continue}o=e.call(t,a)}catch(s){o=[6,s],r=0}finally{n=i=0}if(5&o[0])throw o[1];return{value:o[0]?o[1]:void 0,done:!0}}([o,s])}}},tryGetFromScope=function(t,e){return e.scope===BindingScopeEnum.Singleton&&e.activated?e.cache:e.scope===BindingScopeEnum.Request&&t.has(e.id)?t.get(e.id):null},saveToScope=function(t,e,n){e.scope===BindingScopeEnum.Singleton&&_saveToSingletonScope(e,n),e.scope===BindingScopeEnum.Request&&_saveToRequestScope(t,e,n)},_saveToRequestScope=function(t,e,n){t.has(e.id)||t.set(e.id,n)},_saveToSingletonScope=function(t,e){t.cache=e,t.activated=!0,isPromise(e)&&_saveAsyncResultToSingletonScope(t,e)},_saveAsyncResultToSingletonScope=function(t,e){return __awaiter$3(void 0,void 0,void 0,(function(){var n,r;return __generator$3(this,(function(i){switch(i.label){case 0:return i.trys.push([0,2,,3]),[4,e];case 1:return n=i.sent(),t.cache=n,[3,3];case 2:throw r=i.sent(),t.cache=null,t.activated=!1,r;case 3:return[2]}}))}))},FactoryType,FactoryType2;FactoryType2=FactoryType||(FactoryType={}),FactoryType2.DynamicValue="toDynamicValue",FactoryType2.Factory="toFactory",FactoryType2.Provider="toProvider";var ensureFullyBound=function(t){var e=null;switch(t.type){case BindingTypeEnum.ConstantValue:case BindingTypeEnum.Function:e=t.cache;break;case BindingTypeEnum.Constructor:case BindingTypeEnum.Instance:e=t.implementationType;break;case BindingTypeEnum.DynamicValue:e=t.dynamicValue;break;case BindingTypeEnum.Provider:e=t.provider;break;case BindingTypeEnum.Factory:e=t.factory}if(null===e){var n=getServiceIdentifierAsString(t.serviceIdentifier);throw new Error(INVALID_BINDING_TYPE+" "+n)}},getFactoryDetails=function(t){switch(t.type){case BindingTypeEnum.Factory:return{factory:t.factory,factoryType:FactoryType.Factory};case BindingTypeEnum.Provider:return{factory:t.provider,factoryType:FactoryType.Provider};case BindingTypeEnum.DynamicValue:return{factory:t.dynamicValue,factoryType:FactoryType.DynamicValue};default:throw new Error("Unexpected factory type "+t.type)}},__assign$1=globalThis&&globalThis.__assign||function(){return __assign$1=Object.assign||function(t){for(var e,n=1,r=arguments.length;n<r;n++)for(var i in e=arguments[n])Object.prototype.hasOwnProperty.call(e,i)&&(t[i]=e[i]);return t},__assign$1.apply(this,arguments)},__awaiter$2=globalThis&&globalThis.__awaiter||function(t,e,n,r){return new(n||(n=Promise))((function(i,o){function a(t){try{c(r.next(t))}catch(e){o(e)}}function s(t){try{c(r.throw(t))}catch(e){o(e)}}function c(t){var e;t.done?i(t.value):(e=t.value,e instanceof n?e:new n((function(t){t(e)}))).then(a,s)}c((r=r.apply(t,e||[])).next())}))},__generator$2=globalThis&&globalThis.__generator||function(t,e){var n,r,i,o,a={label:0,sent:function(){if(1&i[0])throw i[1];return i[1]},trys:[],ops:[]};return o={next:s(0),throw:s(1),return:s(2)},"function"==typeof Symbol&&(o[Symbol.iterator]=function(){return this}),o;function s(o){return function(s){return function(o){if(n)throw new TypeError("Generator is already executing.");for(;a;)try{if(n=1,r&&(i=2&o[0]?r.return:o[0]?r.throw||((i=r.return)&&i.call(r),0):r.next)&&!(i=i.call(r,o[1])).done)return i;switch(r=0,i&&(o=[2&o[0],i.value]),o[0]){case 0:case 1:i=o;break;case 4:return a.label++,{value:o[1],done:!1};case 5:a.label++,r=o[1],o=[0];continue;case 7:o=a.ops.pop(),a.trys.pop();continue;default:if(!(i=a.trys,(i=i.length>0&&i[i.length-1])||6!==o[0]&&2!==o[0])){a=0;continue}if(3===o[0]&&(!i||o[1]>i[0]&&o[1]<i[3])){a.label=o[1];break}if(6===o[0]&&a.label<i[1]){a.label=i[1],i=o;break}if(i&&a.label<i[2]){a.label=i[2],a.ops.push(o);break}i[2]&&a.ops.pop(),a.trys.pop();continue}o=e.call(t,a)}catch(s){o=[6,s],r=0}finally{n=i=0}if(5&o[0])throw o[1];return{value:o[0]?o[1]:void 0,done:!0}}([o,s])}}},__spreadArray$1=globalThis&&globalThis.__spreadArray||function(t,e,n){if(n||2===arguments.length)for(var r,i=0,o=e.length;i<o;i++)!r&&i in e||(r||(r=Array.prototype.slice.call(e,0,i)),r[i]=e[i]);return t.concat(r||Array.prototype.slice.call(e))};function _resolveRequests(t,e){return t.reduce((function(t,n){var r=e(n);return n.target.type===TargetTypeEnum.ConstructorArgument?t.constructorInjections.push(r):(t.propertyRequests.push(n),t.propertyInjections.push(r)),t.isAsync||(t.isAsync=isPromiseOrContainsPromise(r)),t}),{constructorInjections:[],propertyInjections:[],propertyRequests:[],isAsync:!1})}function _createInstance(t,e,n){var r;if(e.length>0){var i=_resolveRequests(e,n),o=__assign$1(__assign$1({},i),{constr:t});r=i.isAsync?createInstanceWithInjectionsAsync(o):createInstanceWithInjections(o)}else r=new t;return r}function createInstanceWithInjections(t){var e,n=new((e=t.constr).bind.apply(e,__spreadArray$1([void 0],t.constructorInjections,!1)));return t.propertyRequests.forEach((function(e,r){var i=e.target.identifier,o=t.propertyInjections[r];n[i]=o})),n}function createInstanceWithInjectionsAsync(t){return __awaiter$2(this,void 0,void 0,(function(){var e,n;return __generator$2(this,(function(r){switch(r.label){case 0:return[4,possiblyWaitInjections(t.constructorInjections)];case 1:return e=r.sent(),[4,possiblyWaitInjections(t.propertyInjections)];case 2:return n=r.sent(),[2,createInstanceWithInjections(__assign$1(__assign$1({},t),{constructorInjections:e,propertyInjections:n}))]}}))}))}function possiblyWaitInjections(t){return __awaiter$2(this,void 0,void 0,(function(){var e,n,r,i;return __generator$2(this,(function(o){for(e=[],n=0,r=t;n<r.length;n++)i=r[n],Array.isArray(i)?e.push(Promise.all(i)):e.push(i);return[2,Promise.all(e)]}))}))}function _getInstanceAfterPostConstruct(t,e){var n=_postConstruct(t,e);return isPromise(n)?n.then((function(){return e})):e}function _postConstruct(t,e){var n,r;if(Reflect.hasMetadata(POST_CONSTRUCT,t)){var i=Reflect.getMetadata(POST_CONSTRUCT,t);try{return null===(r=(n=e)[i.value])||void 0===r?void 0:r.call(n)}catch(o){throw new Error(POST_CONSTRUCT_ERROR(t.name,o.message))}}}function _validateInstanceResolution(t,e){t.scope!==BindingScopeEnum.Singleton&&_throwIfHandlingDeactivation(t,e)}function _throwIfHandlingDeactivation(t,e){var n="Class cannot be instantiated in "+(t.scope===BindingScopeEnum.Request?"request":"transient")+" scope.";if("function"==typeof t.onDeactivation)throw new Error(ON_DEACTIVATION_ERROR(e.name,n));if(Reflect.hasMetadata(PRE_DESTROY,e))throw new Error(PRE_DESTROY_ERROR(e.name,n))}function resolveInstance(t,e,n,r){_validateInstanceResolution(t,e);var i=_createInstance(e,n,r);return isPromise(i)?i.then((function(t){return _getInstanceAfterPostConstruct(e,t)})):_getInstanceAfterPostConstruct(e,i)}var __awaiter$1=globalThis&&globalThis.__awaiter||function(t,e,n,r){return new(n||(n=Promise))((function(i,o){function a(t){try{c(r.next(t))}catch(e){o(e)}}function s(t){try{c(r.throw(t))}catch(e){o(e)}}function c(t){var e;t.done?i(t.value):(e=t.value,e instanceof n?e:new n((function(t){t(e)}))).then(a,s)}c((r=r.apply(t,e||[])).next())}))},__generator$1=globalThis&&globalThis.__generator||function(t,e){var n,r,i,o,a={label:0,sent:function(){if(1&i[0])throw i[1];return i[1]},trys:[],ops:[]};return o={next:s(0),throw:s(1),return:s(2)},"function"==typeof Symbol&&(o[Symbol.iterator]=function(){return this}),o;function s(o){return function(s){return function(o){if(n)throw new TypeError("Generator is already executing.");for(;a;)try{if(n=1,r&&(i=2&o[0]?r.return:o[0]?r.throw||((i=r.return)&&i.call(r),0):r.next)&&!(i=i.call(r,o[1])).done)return i;switch(r=0,i&&(o=[2&o[0],i.value]),o[0]){case 0:case 1:i=o;break;case 4:return a.label++,{value:o[1],done:!1};case 5:a.label++,r=o[1],o=[0];continue;case 7:o=a.ops.pop(),a.trys.pop();continue;default:if(!(i=a.trys,(i=i.length>0&&i[i.length-1])||6!==o[0]&&2!==o[0])){a=0;continue}if(3===o[0]&&(!i||o[1]>i[0]&&o[1]<i[3])){a.label=o[1];break}if(6===o[0]&&a.label<i[1]){a.label=i[1],i=o;break}if(i&&a.label<i[2]){a.label=i[2],a.ops.push(o);break}i[2]&&a.ops.pop(),a.trys.pop();continue}o=e.call(t,a)}catch(s){o=[6,s],r=0}finally{n=i=0}if(5&o[0])throw o[1];return{value:o[0]?o[1]:void 0,done:!0}}([o,s])}}},_resolveRequest=function(t){return function(e){e.parentContext.setCurrentRequest(e);var n=e.bindings,r=e.childRequests,i=e.target&&e.target.isArray(),o=!(e.parentRequest&&e.parentRequest.target&&e.target&&e.parentRequest.target.matchesArray(e.target.serviceIdentifier));if(i&&o)return r.map((function(e){return _resolveRequest(t)(e)}));if(!e.target.isOptional()||0!==n.length){var a=n[0];return _resolveBinding(t,e,a)}}},_resolveFactoryFromBinding=function(t,e){var n=getFactoryDetails(t);return tryAndThrowErrorIfStackOverflow((function(){return n.factory.bind(t)(e)}),(function(){return new Error(CIRCULAR_DEPENDENCY_IN_FACTORY(n.factoryType,e.currentRequest.serviceIdentifier.toString()))}))},_getResolvedFromBinding=function(t,e,n){var r,i=e.childRequests;switch(ensureFullyBound(n),n.type){case BindingTypeEnum.ConstantValue:case BindingTypeEnum.Function:r=n.cache;break;case BindingTypeEnum.Constructor:r=n.implementationType;break;case BindingTypeEnum.Instance:r=resolveInstance(n,n.implementationType,i,_resolveRequest(t));break;default:r=_resolveFactoryFromBinding(n,e.parentContext)}return r},_resolveInScope=function(t,e,n){var r=tryGetFromScope(t,e);return null!==r||(r=n(),saveToScope(t,e,r)),r},_resolveBinding=function(t,e,n){return _resolveInScope(t,n,(function(){var r=_getResolvedFromBinding(t,e,n);return r=isPromise(r)?r.then((function(t){return _onActivation(e,n,t)})):_onActivation(e,n,r)}))};function _onActivation(t,e,n){var r,i=_bindingActivation(t.parentContext,e,n),o=_getContainersIterator(t.parentContext.container),a=o.next();do{r=a.value;var s=t.parentContext,c=t.serviceIdentifier,u=_getContainerActivationsForService(r,c);i=isPromise(i)?_activateContainerAsync(u,s,i):_activateContainer(u,s,i),a=o.next()}while(!0!==a.done&&!getBindingDictionary(r).hasKey(t.serviceIdentifier));return i}var _bindingActivation=function(t,e,n){return"function"==typeof e.onActivation?e.onActivation(t,n):n},_activateContainer=function(t,e,n){for(var r=t.next();!r.done;){if(isPromise(n=r.value(e,n)))return _activateContainerAsync(t,e,n);r=t.next()}return n},_activateContainerAsync=function(t,e,n){return __awaiter$1(void 0,void 0,void 0,(function(){var r,i;return __generator$1(this,(function(o){switch(o.label){case 0:return[4,n];case 1:r=o.sent(),i=t.next(),o.label=2;case 2:return i.done?[3,4]:[4,i.value(e,r)];case 3:return r=o.sent(),i=t.next(),[3,2];case 4:return[2,r]}}))}))},_getContainerActivationsForService=function(t,e){var n=t._activations;return n.hasKey(e)?n.get(e).values():[].values()},_getContainersIterator=function(t){for(var e=[t],n=t.parent;null!==n;)e.push(n),n=n.parent;return{next:function(){var t=e.pop();return void 0!==t?{done:!1,value:t}:{done:!0,value:void 0}}}};function resolve(t){return _resolveRequest(t.plan.rootRequest.requestScope)(t.plan.rootRequest)}var traverseAncerstors=function(t,e){var n=t.parentRequest;return null!==n&&(!!e(n)||traverseAncerstors(n,e))},taggedConstraint=function(t){return function(e){var n=function(n){return null!==n&&null!==n.target&&n.target.matchesTag(t)(e)};return n.metaData=new Metadata(t,e),n}},namedConstraint=taggedConstraint(NAMED_TAG),typeConstraint=function(t){return function(e){var n=null;if(null!==e){if(n=e.bindings[0],"string"==typeof t)return n.serviceIdentifier===t;var r=e.bindings[0].implementationType;return t===r}return!1}},BindingWhenSyntax=function(){function t(t){this._binding=t}return t.prototype.when=function(t){return this._binding.constraint=t,new BindingOnSyntax(this._binding)},t.prototype.whenTargetNamed=function(t){return this._binding.constraint=namedConstraint(t),new BindingOnSyntax(this._binding)},t.prototype.whenTargetIsDefault=function(){return this._binding.constraint=function(t){return null!==t&&(null!==t.target&&!t.target.isNamed()&&!t.target.isTagged())},new BindingOnSyntax(this._binding)},t.prototype.whenTargetTagged=function(t,e){return this._binding.constraint=taggedConstraint(t)(e),new BindingOnSyntax(this._binding)},t.prototype.whenInjectedInto=function(t){return this._binding.constraint=function(e){return null!==e&&typeConstraint(t)(e.parentRequest)},new BindingOnSyntax(this._binding)},t.prototype.whenParentNamed=function(t){return this._binding.constraint=function(e){return null!==e&&namedConstraint(t)(e.parentRequest)},new BindingOnSyntax(this._binding)},t.prototype.whenParentTagged=function(t,e){return this._binding.constraint=function(n){return null!==n&&taggedConstraint(t)(e)(n.parentRequest)},new BindingOnSyntax(this._binding)},t.prototype.whenAnyAncestorIs=function(t){return this._binding.constraint=function(e){return null!==e&&traverseAncerstors(e,typeConstraint(t))},new BindingOnSyntax(this._binding)},t.prototype.whenNoAncestorIs=function(t){return this._binding.constraint=function(e){return null!==e&&!traverseAncerstors(e,typeConstraint(t))},new BindingOnSyntax(this._binding)},t.prototype.whenAnyAncestorNamed=function(t){return this._binding.constraint=function(e){return null!==e&&traverseAncerstors(e,namedConstraint(t))},new BindingOnSyntax(this._binding)},t.prototype.whenNoAncestorNamed=function(t){return this._binding.constraint=function(e){return null!==e&&!traverseAncerstors(e,namedConstraint(t))},new BindingOnSyntax(this._binding)},t.prototype.whenAnyAncestorTagged=function(t,e){return this._binding.constraint=function(n){return null!==n&&traverseAncerstors(n,taggedConstraint(t)(e))},new BindingOnSyntax(this._binding)},t.prototype.whenNoAncestorTagged=function(t,e){return this._binding.constraint=function(n){return null!==n&&!traverseAncerstors(n,taggedConstraint(t)(e))},new BindingOnSyntax(this._binding)},t.prototype.whenAnyAncestorMatches=function(t){return this._binding.constraint=function(e){return null!==e&&traverseAncerstors(e,t)},new BindingOnSyntax(this._binding)},t.prototype.whenNoAncestorMatches=function(t){return this._binding.constraint=function(e){return null!==e&&!traverseAncerstors(e,t)},new BindingOnSyntax(this._binding)},t}(),BindingOnSyntax=function(){function t(t){this._binding=t}return t.prototype.onActivation=function(t){return this._binding.onActivation=t,new BindingWhenSyntax(this._binding)},t.prototype.onDeactivation=function(t){return this._binding.onDeactivation=t,new BindingWhenSyntax(this._binding)},t}(),BindingWhenOnSyntax=function(){function t(t){this._binding=t,this._bindingWhenSyntax=new BindingWhenSyntax(this._binding),this._bindingOnSyntax=new BindingOnSyntax(this._binding)}return t.prototype.when=function(t){return this._bindingWhenSyntax.when(t)},t.prototype.whenTargetNamed=function(t){return this._bindingWhenSyntax.whenTargetNamed(t)},t.prototype.whenTargetIsDefault=function(){return this._bindingWhenSyntax.whenTargetIsDefault()},t.prototype.whenTargetTagged=function(t,e){return this._bindingWhenSyntax.whenTargetTagged(t,e)},t.prototype.whenInjectedInto=function(t){return this._bindingWhenSyntax.whenInjectedInto(t)},t.prototype.whenParentNamed=function(t){return this._bindingWhenSyntax.whenParentNamed(t)},t.prototype.whenParentTagged=function(t,e){return this._bindingWhenSyntax.whenParentTagged(t,e)},t.prototype.whenAnyAncestorIs=function(t){return this._bindingWhenSyntax.whenAnyAncestorIs(t)},t.prototype.whenNoAncestorIs=function(t){return this._bindingWhenSyntax.whenNoAncestorIs(t)},t.prototype.whenAnyAncestorNamed=function(t){return this._bindingWhenSyntax.whenAnyAncestorNamed(t)},t.prototype.whenAnyAncestorTagged=function(t,e){return this._bindingWhenSyntax.whenAnyAncestorTagged(t,e)},t.prototype.whenNoAncestorNamed=function(t){return this._bindingWhenSyntax.whenNoAncestorNamed(t)},t.prototype.whenNoAncestorTagged=function(t,e){return this._bindingWhenSyntax.whenNoAncestorTagged(t,e)},t.prototype.whenAnyAncestorMatches=function(t){return this._bindingWhenSyntax.whenAnyAncestorMatches(t)},t.prototype.whenNoAncestorMatches=function(t){return this._bindingWhenSyntax.whenNoAncestorMatches(t)},t.prototype.onActivation=function(t){return this._bindingOnSyntax.onActivation(t)},t.prototype.onDeactivation=function(t){return this._bindingOnSyntax.onDeactivation(t)},t}(),BindingInSyntax=function(){function t(t){this._binding=t}return t.prototype.inRequestScope=function(){return this._binding.scope=BindingScopeEnum.Request,new BindingWhenOnSyntax(this._binding)},t.prototype.inSingletonScope=function(){return this._binding.scope=BindingScopeEnum.Singleton,new BindingWhenOnSyntax(this._binding)},t.prototype.inTransientScope=function(){return this._binding.scope=BindingScopeEnum.Transient,new BindingWhenOnSyntax(this._binding)},t}(),BindingInWhenOnSyntax=function(){function t(t){this._binding=t,this._bindingWhenSyntax=new BindingWhenSyntax(this._binding),this._bindingOnSyntax=new BindingOnSyntax(this._binding),this._bindingInSyntax=new BindingInSyntax(t)}return t.prototype.inRequestScope=function(){return this._bindingInSyntax.inRequestScope()},t.prototype.inSingletonScope=function(){return this._bindingInSyntax.inSingletonScope()},t.prototype.inTransientScope=function(){return this._bindingInSyntax.inTransientScope()},t.prototype.when=function(t){return this._bindingWhenSyntax.when(t)},t.prototype.whenTargetNamed=function(t){return this._bindingWhenSyntax.whenTargetNamed(t)},t.prototype.whenTargetIsDefault=function(){return this._bindingWhenSyntax.whenTargetIsDefault()},t.prototype.whenTargetTagged=function(t,e){return this._bindingWhenSyntax.whenTargetTagged(t,e)},t.prototype.whenInjectedInto=function(t){return this._bindingWhenSyntax.whenInjectedInto(t)},t.prototype.whenParentNamed=function(t){return this._bindingWhenSyntax.whenParentNamed(t)},t.prototype.whenParentTagged=function(t,e){return this._bindingWhenSyntax.whenParentTagged(t,e)},t.prototype.whenAnyAncestorIs=function(t){return this._bindingWhenSyntax.whenAnyAncestorIs(t)},t.prototype.whenNoAncestorIs=function(t){return this._bindingWhenSyntax.whenNoAncestorIs(t)},t.prototype.whenAnyAncestorNamed=function(t){return this._bindingWhenSyntax.whenAnyAncestorNamed(t)},t.prototype.whenAnyAncestorTagged=function(t,e){return this._bindingWhenSyntax.whenAnyAncestorTagged(t,e)},t.prototype.whenNoAncestorNamed=function(t){return this._bindingWhenSyntax.whenNoAncestorNamed(t)},t.prototype.whenNoAncestorTagged=function(t,e){return this._bindingWhenSyntax.whenNoAncestorTagged(t,e)},t.prototype.whenAnyAncestorMatches=function(t){return this._bindingWhenSyntax.whenAnyAncestorMatches(t)},t.prototype.whenNoAncestorMatches=function(t){return this._bindingWhenSyntax.whenNoAncestorMatches(t)},t.prototype.onActivation=function(t){return this._bindingOnSyntax.onActivation(t)},t.prototype.onDeactivation=function(t){return this._bindingOnSyntax.onDeactivation(t)},t}(),BindingToSyntax=function(){function t(t){this._binding=t}return t.prototype.to=function(t){return this._binding.type=BindingTypeEnum.Instance,this._binding.implementationType=t,new BindingInWhenOnSyntax(this._binding)},t.prototype.toSelf=function(){if("function"!=typeof this._binding.serviceIdentifier)throw new Error(""+INVALID_TO_SELF_VALUE);var t=this._binding.serviceIdentifier;return this.to(t)},t.prototype.toConstantValue=function(t){return this._binding.type=BindingTypeEnum.ConstantValue,this._binding.cache=t,this._binding.dynamicValue=null,this._binding.implementationType=null,this._binding.scope=BindingScopeEnum.Singleton,new BindingWhenOnSyntax(this._binding)},t.prototype.toDynamicValue=function(t){return this._binding.type=BindingTypeEnum.DynamicValue,this._binding.cache=null,this._binding.dynamicValue=t,this._binding.implementationType=null,new BindingInWhenOnSyntax(this._binding)},t.prototype.toConstructor=function(t){return this._binding.type=BindingTypeEnum.Constructor,this._binding.implementationType=t,this._binding.scope=BindingScopeEnum.Singleton,new BindingWhenOnSyntax(this._binding)},t.prototype.toFactory=function(t){return this._binding.type=BindingTypeEnum.Factory,this._binding.factory=t,this._binding.scope=BindingScopeEnum.Singleton,new BindingWhenOnSyntax(this._binding)},t.prototype.toFunction=function(t){if("function"!=typeof t)throw new Error(INVALID_FUNCTION_BINDING);var e=this.toConstantValue(t);return this._binding.type=BindingTypeEnum.Function,this._binding.scope=BindingScopeEnum.Singleton,e},t.prototype.toAutoFactory=function(t){return this._binding.type=BindingTypeEnum.Factory,this._binding.factory=function(e){return function(){return e.container.get(t)}},this._binding.scope=BindingScopeEnum.Singleton,new BindingWhenOnSyntax(this._binding)},t.prototype.toAutoNamedFactory=function(t){return this._binding.type=BindingTypeEnum.Factory,this._binding.factory=function(e){return function(n){return e.container.getNamed(t,n)}},new BindingWhenOnSyntax(this._binding)},t.prototype.toProvider=function(t){return this._binding.type=BindingTypeEnum.Provider,this._binding.provider=t,this._binding.scope=BindingScopeEnum.Singleton,new BindingWhenOnSyntax(this._binding)},t.prototype.toService=function(t){this.toDynamicValue((function(e){return e.container.get(t)}))},t}(),ContainerSnapshot=function(){function t(){}return t.of=function(e,n,r,i,o){var a=new t;return a.bindings=e,a.middleware=n,a.deactivations=i,a.activations=r,a.moduleActivationStore=o,a},t}();function isClonable(t){return"object"==typeof t&&null!==t&&"clone"in t&&"function"==typeof t.clone}var Lookup=function(){function t(){this._map=new Map}return t.prototype.getMap=function(){return this._map},t.prototype.add=function(t,e){if(null==t)throw new Error(NULL_ARGUMENT);if(null==e)throw new Error(NULL_ARGUMENT);var n=this._map.get(t);void 0!==n?n.push(e):this._map.set(t,[e])},t.prototype.get=function(t){if(null==t)throw new Error(NULL_ARGUMENT);var e=this._map.get(t);if(void 0!==e)return e;throw new Error(KEY_NOT_FOUND)},t.prototype.remove=function(t){if(null==t)throw new Error(NULL_ARGUMENT);if(!this._map.delete(t))throw new Error(KEY_NOT_FOUND)},t.prototype.removeIntersection=function(t){var e=this;this.traverse((function(n,r){var i=t.hasKey(n)?t.get(n):void 0;if(void 0!==i){var o=r.filter((function(t){return!i.some((function(e){return t===e}))}));e._setValue(n,o)}}))},t.prototype.removeByCondition=function(t){var e=this,n=[];return this._map.forEach((function(r,i){for(var o=[],a=0,s=r;a<s.length;a++){var c=s[a];t(c)?n.push(c):o.push(c)}e._setValue(i,o)})),n},t.prototype.hasKey=function(t){if(null==t)throw new Error(NULL_ARGUMENT);return this._map.has(t)},t.prototype.clone=function(){var e=new t;return this._map.forEach((function(t,n){t.forEach((function(t){return e.add(n,isClonable(t)?t.clone():t)}))})),e},t.prototype.traverse=function(t){this._map.forEach((function(e,n){t(n,e)}))},t.prototype._setValue=function(t,e){e.length>0?this._map.set(t,e):this._map.delete(t)},t}(),ModuleActivationStore=function(){function t(){this._map=new Map}return t.prototype.remove=function(t){if(this._map.has(t)){var e=this._map.get(t);return this._map.delete(t),e}return this._getEmptyHandlersStore()},t.prototype.addDeactivation=function(t,e,n){this._getModuleActivationHandlers(t).onDeactivations.add(e,n)},t.prototype.addActivation=function(t,e,n){this._getModuleActivationHandlers(t).onActivations.add(e,n)},t.prototype.clone=function(){var e=new t;return this._map.forEach((function(t,n){e._map.set(n,{onActivations:t.onActivations.clone(),onDeactivations:t.onDeactivations.clone()})})),e},t.prototype._getModuleActivationHandlers=function(t){var e=this._map.get(t);return void 0===e&&(e=this._getEmptyHandlersStore(),this._map.set(t,e)),e},t.prototype._getEmptyHandlersStore=function(){return{onActivations:new Lookup,onDeactivations:new Lookup}},t}(),__assign=globalThis&&globalThis.__assign||function(){return __assign=Object.assign||function(t){for(var e,n=1,r=arguments.length;n<r;n++)for(var i in e=arguments[n])Object.prototype.hasOwnProperty.call(e,i)&&(t[i]=e[i]);return t},__assign.apply(this,arguments)},__awaiter=globalThis&&globalThis.__awaiter||function(t,e,n,r){return new(n||(n=Promise))((function(i,o){function a(t){try{c(r.next(t))}catch(e){o(e)}}function s(t){try{c(r.throw(t))}catch(e){o(e)}}function c(t){var e;t.done?i(t.value):(e=t.value,e instanceof n?e:new n((function(t){t(e)}))).then(a,s)}c((r=r.apply(t,e||[])).next())}))},__generator=globalThis&&globalThis.__generator||function(t,e){var n,r,i,o,a={label:0,sent:function(){if(1&i[0])throw i[1];return i[1]},trys:[],ops:[]};return o={next:s(0),throw:s(1),return:s(2)},"function"==typeof Symbol&&(o[Symbol.iterator]=function(){return this}),o;function s(o){return function(s){return function(o){if(n)throw new TypeError("Generator is already executing.");for(;a;)try{if(n=1,r&&(i=2&o[0]?r.return:o[0]?r.throw||((i=r.return)&&i.call(r),0):r.next)&&!(i=i.call(r,o[1])).done)return i;switch(r=0,i&&(o=[2&o[0],i.value]),o[0]){case 0:case 1:i=o;break;case 4:return a.label++,{value:o[1],done:!1};case 5:a.label++,r=o[1],o=[0];continue;case 7:o=a.ops.pop(),a.trys.pop();continue;default:if(!(i=a.trys,(i=i.length>0&&i[i.length-1])||6!==o[0]&&2!==o[0])){a=0;continue}if(3===o[0]&&(!i||o[1]>i[0]&&o[1]<i[3])){a.label=o[1];break}if(6===o[0]&&a.label<i[1]){a.label=i[1],i=o;break}if(i&&a.label<i[2]){a.label=i[2],a.ops.push(o);break}i[2]&&a.ops.pop(),a.trys.pop();continue}o=e.call(t,a)}catch(s){o=[6,s],r=0}finally{n=i=0}if(5&o[0])throw o[1];return{value:o[0]?o[1]:void 0,done:!0}}([o,s])}}},__spreadArray=globalThis&&globalThis.__spreadArray||function(t,e,n){if(n||2===arguments.length)for(var r,i=0,o=e.length;i<o;i++)!r&&i in e||(r||(r=Array.prototype.slice.call(e,0,i)),r[i]=e[i]);return t.concat(r||Array.prototype.slice.call(e))},Container=function(){function t(t){var e=t||{};if("object"!=typeof e)throw new Error(""+CONTAINER_OPTIONS_MUST_BE_AN_OBJECT);if(void 0===e.defaultScope)e.defaultScope=BindingScopeEnum.Transient;else if(e.defaultScope!==BindingScopeEnum.Singleton&&e.defaultScope!==BindingScopeEnum.Transient&&e.defaultScope!==BindingScopeEnum.Request)throw new Error(""+CONTAINER_OPTIONS_INVALID_DEFAULT_SCOPE);if(void 0===e.autoBindInjectable)e.autoBindInjectable=!1;else if("boolean"!=typeof e.autoBindInjectable)throw new Error(""+CONTAINER_OPTIONS_INVALID_AUTO_BIND_INJECTABLE);if(void 0===e.skipBaseClassChecks)e.skipBaseClassChecks=!1;else if("boolean"!=typeof e.skipBaseClassChecks)throw new Error(""+CONTAINER_OPTIONS_INVALID_SKIP_BASE_CHECK);this.options={autoBindInjectable:e.autoBindInjectable,defaultScope:e.defaultScope,skipBaseClassChecks:e.skipBaseClassChecks},this.id=id(),this._bindingDictionary=new Lookup,this._snapshots=[],this._middleware=null,this._activations=new Lookup,this._deactivations=new Lookup,this.parent=null,this._metadataReader=new MetadataReader,this._moduleActivationStore=new ModuleActivationStore}return t.merge=function(e,n){for(var r=[],i=2;i<arguments.length;i++)r[i-2]=arguments[i];var o=new t,a=__spreadArray([e,n],r,!0).map((function(t){return getBindingDictionary(t)})),s=getBindingDictionary(o);return a.forEach((function(t){var e;e=s,t.traverse((function(t,n){n.forEach((function(t){e.add(t.serviceIdentifier,t.clone())}))}))})),o},t.prototype.load=function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];for(var n=this._getContainerModuleHelpersFactory(),r=0,i=t;r<i.length;r++){var o=i[r],a=n(o.id);o.registry(a.bindFunction,a.unbindFunction,a.isboundFunction,a.rebindFunction,a.unbindAsyncFunction,a.onActivationFunction,a.onDeactivationFunction)}},t.prototype.loadAsync=function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];return __awaiter(this,void 0,void 0,(function(){var e,n,r,i,o;return __generator(this,(function(a){switch(a.label){case 0:e=this._getContainerModuleHelpersFactory(),n=0,r=t,a.label=1;case 1:return n<r.length?(i=r[n],o=e(i.id),[4,i.registry(o.bindFunction,o.unbindFunction,o.isboundFunction,o.rebindFunction,o.unbindAsyncFunction,o.onActivationFunction,o.onDeactivationFunction)]):[3,4];case 2:a.sent(),a.label=3;case 3:return n++,[3,1];case 4:return[2]}}))}))},t.prototype.unload=function(){for(var t=this,e=[],n=0;n<arguments.length;n++)e[n]=arguments[n];e.forEach((function(e){var n=t._removeModuleBindings(e.id);t._deactivateSingletons(n),t._removeModuleHandlers(e.id)}))},t.prototype.unloadAsync=function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];return __awaiter(this,void 0,void 0,(function(){var e,n,r,i;return __generator(this,(function(o){switch(o.label){case 0:e=0,n=t,o.label=1;case 1:return e<n.length?(r=n[e],i=this._removeModuleBindings(r.id),[4,this._deactivateSingletonsAsync(i)]):[3,4];case 2:o.sent(),this._removeModuleHandlers(r.id),o.label=3;case 3:return e++,[3,1];case 4:return[2]}}))}))},t.prototype.bind=function(t){var e=this.options.defaultScope||BindingScopeEnum.Transient,n=new Binding(t,e);return this._bindingDictionary.add(t,n),new BindingToSyntax(n)},t.prototype.rebind=function(t){return this.unbind(t),this.bind(t)},t.prototype.rebindAsync=function(t){return __awaiter(this,void 0,void 0,(function(){return __generator(this,(function(e){switch(e.label){case 0:return[4,this.unbindAsync(t)];case 1:return e.sent(),[2,this.bind(t)]}}))}))},t.prototype.unbind=function(t){if(this._bindingDictionary.hasKey(t)){var e=this._bindingDictionary.get(t);this._deactivateSingletons(e)}this._removeServiceFromDictionary(t)},t.prototype.unbindAsync=function(t){return __awaiter(this,void 0,void 0,(function(){var e;return __generator(this,(function(n){switch(n.label){case 0:return this._bindingDictionary.hasKey(t)?(e=this._bindingDictionary.get(t),[4,this._deactivateSingletonsAsync(e)]):[3,2];case 1:n.sent(),n.label=2;case 2:return this._removeServiceFromDictionary(t),[2]}}))}))},t.prototype.unbindAll=function(){var t=this;this._bindingDictionary.traverse((function(e,n){t._deactivateSingletons(n)})),this._bindingDictionary=new Lookup},t.prototype.unbindAllAsync=function(){return __awaiter(this,void 0,void 0,(function(){var t,e=this;return __generator(this,(function(n){switch(n.label){case 0:return t=[],this._bindingDictionary.traverse((function(n,r){t.push(e._deactivateSingletonsAsync(r))})),[4,Promise.all(t)];case 1:return n.sent(),this._bindingDictionary=new Lookup,[2]}}))}))},t.prototype.onActivation=function(t,e){this._activations.add(t,e)},t.prototype.onDeactivation=function(t,e){this._deactivations.add(t,e)},t.prototype.isBound=function(t){var e=this._bindingDictionary.hasKey(t);return!e&&this.parent&&(e=this.parent.isBound(t)),e},t.prototype.isCurrentBound=function(t){return this._bindingDictionary.hasKey(t)},t.prototype.isBoundNamed=function(t,e){return this.isBoundTagged(t,NAMED_TAG,e)},t.prototype.isBoundTagged=function(t,e,n){var r=!1;if(this._bindingDictionary.hasKey(t)){var i=this._bindingDictionary.get(t),o=createMockRequest(this,t,e,n);r=i.some((function(t){return t.constraint(o)}))}return!r&&this.parent&&(r=this.parent.isBoundTagged(t,e,n)),r},t.prototype.snapshot=function(){this._snapshots.push(ContainerSnapshot.of(this._bindingDictionary.clone(),this._middleware,this._activations.clone(),this._deactivations.clone(),this._moduleActivationStore.clone()))},t.prototype.restore=function(){var t=this._snapshots.pop();if(void 0===t)throw new Error(NO_MORE_SNAPSHOTS_AVAILABLE);this._bindingDictionary=t.bindings,this._activations=t.activations,this._deactivations=t.deactivations,this._middleware=t.middleware,this._moduleActivationStore=t.moduleActivationStore},t.prototype.createChild=function(e){var n=new t(e||this.options);return n.parent=this,n},t.prototype.applyMiddleware=function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];var n=this._middleware?this._middleware:this._planAndResolve();this._middleware=t.reduce((function(t,e){return e(t)}),n)},t.prototype.applyCustomMetadataReader=function(t){this._metadataReader=t},t.prototype.get=function(t){var e=this._getNotAllArgs(t,!1);return this._getButThrowIfAsync(e)},t.prototype.getAsync=function(t){return __awaiter(this,void 0,void 0,(function(){var e;return __generator(this,(function(n){return e=this._getNotAllArgs(t,!1),[2,this._get(e)]}))}))},t.prototype.getTagged=function(t,e,n){var r=this._getNotAllArgs(t,!1,e,n);return this._getButThrowIfAsync(r)},t.prototype.getTaggedAsync=function(t,e,n){return __awaiter(this,void 0,void 0,(function(){var r;return __generator(this,(function(i){return r=this._getNotAllArgs(t,!1,e,n),[2,this._get(r)]}))}))},t.prototype.getNamed=function(t,e){return this.getTagged(t,NAMED_TAG,e)},t.prototype.getNamedAsync=function(t,e){return this.getTaggedAsync(t,NAMED_TAG,e)},t.prototype.getAll=function(t){var e=this._getAllArgs(t);return this._getButThrowIfAsync(e)},t.prototype.getAllAsync=function(t){var e=this._getAllArgs(t);return this._getAll(e)},t.prototype.getAllTagged=function(t,e,n){var r=this._getNotAllArgs(t,!0,e,n);return this._getButThrowIfAsync(r)},t.prototype.getAllTaggedAsync=function(t,e,n){var r=this._getNotAllArgs(t,!0,e,n);return this._getAll(r)},t.prototype.getAllNamed=function(t,e){return this.getAllTagged(t,NAMED_TAG,e)},t.prototype.getAllNamedAsync=function(t,e){return this.getAllTaggedAsync(t,NAMED_TAG,e)},t.prototype.resolve=function(t){var e=this.isBound(t);e||this.bind(t).toSelf();var n=this.get(t);return e||this.unbind(t),n},t.prototype._preDestroy=function(t,e){if(Reflect.hasMetadata(PRE_DESTROY,t))return e[Reflect.getMetadata(PRE_DESTROY,t).value]()},t.prototype._removeModuleHandlers=function(t){var e=this._moduleActivationStore.remove(t);this._activations.removeIntersection(e.onActivations),this._deactivations.removeIntersection(e.onDeactivations)},t.prototype._removeModuleBindings=function(t){return this._bindingDictionary.removeByCondition((function(e){return e.moduleId===t}))},t.prototype._deactivate=function(t,e){var n=this,r=Object.getPrototypeOf(e).constructor;try{if(this._deactivations.hasKey(t.serviceIdentifier)){var i=this._deactivateContainer(e,this._deactivations.get(t.serviceIdentifier).values());if(isPromise(i))return this._handleDeactivationError(i.then((function(){return n._propagateContainerDeactivationThenBindingAndPreDestroyAsync(t,e,r)})),r)}var o=this._propagateContainerDeactivationThenBindingAndPreDestroy(t,e,r);if(isPromise(o))return this._handleDeactivationError(o,r)}catch(a){throw new Error(ON_DEACTIVATION_ERROR(r.name,a.message))}},t.prototype._handleDeactivationError=function(t,e){return __awaiter(this,void 0,void 0,(function(){var n;return __generator(this,(function(r){switch(r.label){case 0:return r.trys.push([0,2,,3]),[4,t];case 1:return r.sent(),[3,3];case 2:throw n=r.sent(),new Error(ON_DEACTIVATION_ERROR(e.name,n.message));case 3:return[2]}}))}))},t.prototype._deactivateContainer=function(t,e){for(var n=this,r=e.next();r.value;){var i=r.value(t);if(isPromise(i))return i.then((function(){return n._deactivateContainerAsync(t,e)}));r=e.next()}},t.prototype._deactivateContainerAsync=function(t,e){return __awaiter(this,void 0,void 0,(function(){var n;return __generator(this,(function(r){switch(r.label){case 0:n=e.next(),r.label=1;case 1:return n.value?[4,n.value(t)]:[3,3];case 2:return r.sent(),n=e.next(),[3,1];case 3:return[2]}}))}))},t.prototype._getContainerModuleHelpersFactory=function(){var t=this,e=function(t,e){t._binding.moduleId=e},n=function(n){return function(r){var i=t.rebind(r);return e(i,n),i}},r=function(e){return function(n,r){t._moduleActivationStore.addActivation(e,n,r),t.onActivation(n,r)}},i=function(e){return function(n,r){t._moduleActivationStore.addDeactivation(e,n,r),t.onDeactivation(n,r)}};return function(o){return{bindFunction:(a=o,function(n){var r=t.bind(n);return e(r,a),r}),isboundFunction:function(e){return t.isBound(e)},onActivationFunction:r(o),onDeactivationFunction:i(o),rebindFunction:n(o),unbindFunction:function(e){return t.unbind(e)},unbindAsyncFunction:function(e){return t.unbindAsync(e)}};var a}},t.prototype._getAll=function(t){return Promise.all(this._get(t))},t.prototype._get=function(t){var e=__assign(__assign({},t),{contextInterceptor:function(t){return t},targetType:TargetTypeEnum.Variable});if(this._middleware){var n=this._middleware(e);if(null==n)throw new Error(INVALID_MIDDLEWARE_RETURN);return n}return this._planAndResolve()(e)},t.prototype._getButThrowIfAsync=function(t){var e=this._get(t);if(isPromiseOrContainsPromise(e))throw new Error(LAZY_IN_SYNC(t.serviceIdentifier));return e},t.prototype._getAllArgs=function(t){return{avoidConstraints:!0,isMultiInject:!0,serviceIdentifier:t}},t.prototype._getNotAllArgs=function(t,e,n,r){return{avoidConstraints:!1,isMultiInject:e,serviceIdentifier:t,key:n,value:r}},t.prototype._planAndResolve=function(){var t=this;return function(e){var n=plan(t._metadataReader,t,e.isMultiInject,e.targetType,e.serviceIdentifier,e.key,e.value,e.avoidConstraints);return resolve(n=e.contextInterceptor(n))}},t.prototype._deactivateIfSingleton=function(t){var e=this;if(t.activated)return isPromise(t.cache)?t.cache.then((function(n){return e._deactivate(t,n)})):this._deactivate(t,t.cache)},t.prototype._deactivateSingletons=function(t){for(var e=0,n=t;e<n.length;e++){var r=n[e];if(isPromise(this._deactivateIfSingleton(r)))throw new Error(ASYNC_UNBIND_REQUIRED)}},t.prototype._deactivateSingletonsAsync=function(t){return __awaiter(this,void 0,void 0,(function(){var e=this;return __generator(this,(function(n){switch(n.label){case 0:return[4,Promise.all(t.map((function(t){return e._deactivateIfSingleton(t)})))];case 1:return n.sent(),[2]}}))}))},t.prototype._propagateContainerDeactivationThenBindingAndPreDestroy=function(t,e,n){return this.parent?this._deactivate.bind(this.parent)(t,e):this._bindingDeactivationAndPreDestroy(t,e,n)},t.prototype._propagateContainerDeactivationThenBindingAndPreDestroyAsync=function(t,e,n){return __awaiter(this,void 0,void 0,(function(){return __generator(this,(function(r){switch(r.label){case 0:return this.parent?[4,this._deactivate.bind(this.parent)(t,e)]:[3,2];case 1:return r.sent(),[3,4];case 2:return[4,this._bindingDeactivationAndPreDestroyAsync(t,e,n)];case 3:r.sent(),r.label=4;case 4:return[2]}}))}))},t.prototype._removeServiceFromDictionary=function(t){try{this._bindingDictionary.remove(t)}catch(e){throw new Error(CANNOT_UNBIND+" "+getServiceIdentifierAsString(t))}},t.prototype._bindingDeactivationAndPreDestroy=function(t,e,n){var r=this;if("function"==typeof t.onDeactivation){var i=t.onDeactivation(e);if(isPromise(i))return i.then((function(){return r._preDestroy(n,e)}))}return this._preDestroy(n,e)},t.prototype._bindingDeactivationAndPreDestroyAsync=function(t,e,n){return __awaiter(this,void 0,void 0,(function(){return __generator(this,(function(r){switch(r.label){case 0:return"function"!=typeof t.onDeactivation?[3,2]:[4,t.onDeactivation(e)];case 1:r.sent(),r.label=2;case 2:return[4,this._preDestroy(n,e)];case 3:return r.sent(),[2]}}))}))},t}();function getFirstArrayDuplicate(t){for(var e=new Set,n=0,r=t;n<r.length;n++){var i=r[n];if(e.has(i))return i;e.add(i)}}function targetIsConstructorFunction(t){return void 0!==t.prototype}function _throwIfMethodParameter(t){if(void 0!==t)throw new Error(INVALID_DECORATOR_OPERATION)}function tagParameter(t,e,n,r){_throwIfMethodParameter(e),_tagParameterOrProperty(TAGGED,t,n.toString(),r)}function tagProperty(t,e,n){if(targetIsConstructorFunction(t))throw new Error(INVALID_DECORATOR_OPERATION);_tagParameterOrProperty(TAGGED_PROP,t.constructor,e,n)}function _ensureNoMetadataKeyDuplicates(t){var e=[];if(Array.isArray(t)){var n=getFirstArrayDuplicate((e=t).map((function(t){return t.key})));if(void 0!==n)throw new Error(DUPLICATED_METADATA+" "+n.toString())}else e=[t];return e}function _tagParameterOrProperty(t,e,n,r){var i=_ensureNoMetadataKeyDuplicates(r),o={};Reflect.hasOwnMetadata(t,e)&&(o=Reflect.getMetadata(t,e));var a=o[n];if(void 0===a)a=[];else for(var s=function(t){if(i.some((function(e){return e.key===t.key})))throw new Error(DUPLICATED_METADATA+" "+t.key.toString())},c=0,u=a;c<u.length;c++){s(u[c])}a.push.apply(a,i),o[n]=a,Reflect.defineMetadata(t,o,e)}function createTaggedDecorator(t){return function(e,n,r){"number"==typeof r?tagParameter(e,n,r,t):tagProperty(e,n,t)}}function injectable(){return function(t){if(Reflect.hasOwnMetadata(PARAM_TYPES,t))throw new Error(DUPLICATED_INJECTABLE_DECORATOR);var e=Reflect.getMetadata(DESIGN_PARAM_TYPES,t)||[];return Reflect.defineMetadata(PARAM_TYPES,e,t),t}}function injectBase(t){return function(e){return function(n,r,i){if(void 0===e){var o="function"==typeof n?n.name:n.constructor.name;throw new Error(UNDEFINED_INJECT_ANNOTATION(o))}return createTaggedDecorator(new Metadata(t,e))(n,r,i)}}}var inject=injectBase(INJECT_TAG),commonjsGlobal="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:{},Reflect$1,Reflect2;async function request(t,e){let n=null;return await fetch(t,{body:JSON.stringify(e),method:"POST",headers:{Authorization:`Token ${config().token}`}}).then((function(t){n=t.json()})),n}async function parseBody(t){let e=await t;return 0===e.code?e.data:null}async function transactions(t,e=[]){const n=new URL(t.ws.ws.url);return parseBody(request("/api/transactions",{app:n.searchParams.get("app"),session:n.searchParams.get("id"),transactions:e}))}async function sql(t){return parseBody(request("/api/query/sql",{stmt:t}))}async function lsNotebooks(t){return parseBody(request("/api/notebook/lsNotebooks",{stmt:t}))}async function getAnchor(t,e){let n=`select * from blocks where id = '${t=t.replace("((","").replace("))","")}'`,r=await sql(n),i="";if(r)try{i=r[0][e]?r[0][e]:r[0].content?r[0].content:t}catch(o){i=""}return i}async function openNotebook(t){return parseBody(request("/api/notebook/openNotebook",{notebook:t}))}async function closeNotebook(t){return parseBody(request("/api/notebook/closeNotebook",{notebook:t}))}async function renameNotebook(t,e){return parseBody(request("/api/notebook/renameNotebook",{notebook:t,name:e}))}async function createNotebook(t){return parseBody(request("/api/notebook/createNotebook",{name:t}))}async function removeNotebook(t){return parseBody(request("/api/notebook/removeNotebook",{notebook:t}))}async function getNotebookConf(t){return parseBody(request("/api/notebook/getNotebookConf",{notebook:t}))}async function setNotebookConf(t){return parseBody(request("/api/notebook/setNotebookConf",{notebook:t}))}async function renameDoc(t,e,n){return parseBody(request("/api/filetree/renameDoc",{notebook:t,path:e,title:n}))}async function removeDoc(t,e){return parseBody(request("/api/filetree/removeDoc",{notebook:t,path:e}))}async function moveDoc(t,e,n,r){return parseBody(request("/api/filetree/moveDoc",{fromNotebook:t,fromPath:e,toNotebook:n,toPath:r}))}async function getHPathByPath(t,e){return parseBody(request("/api/filetree/getHPathByPath",{Notebook:t,Path:e}))}async function getHPathByID(t){return parseBody(request("/api/filetree/getHPathByID",{id:t}))}async function getBlockAttrs(t){return parseBody(request("/api/attr/getBlockAttrs",{id:t}))}async function getBlockByID(t){let e=`select * from blocks where id ='${t}'`;return(await sql(e))[0]}async function getBlockKramdown(t){return parseBody(request("/api/block/getBlockKramdown",{id:t}))}async function getBlockBreadcrumb(t){return parseBody(request("/api/block/getBlockBreadcrumb",{id:t}))}async function setBlockAttrs(t,e){return parseBody(request("/api/attr/setBlockAttrs",{id:t,attrs:e}))}async function exportMdContent(t){return parseBody(request("/api/export/exportMdContent",{id:t}))}async function getDocOutline(t){return parseBody(request("/api/outline/getDocOutline",{id:t}))}async function listDocsByPath(t){return parseBody(request("/api/filetree/listDocsByPath",{path:t}))}async function getBacklink(t){return parseBody(request("/api/ref/getBacklink",{id:t,beforeLen:10,k:"",mk:""}))}async function searchEmbedBlock(t,e){return parseBody(request("/api/search/searchEmbedBlock",{stmt:e,excludeIDs:t}))}async function getDoc(t){return parseBody(request("/api/filetree/getDoc",{id:t,k:"",mode:2,size:36}))}async function getFocusedDoc(t){return parseBody(request("/api/filetree/getDoc",{id:t,k:"",mode:0,size:36}))}async function getTag(){return parseBody(request("/api/tag/getTag",{}))}async function getLocalGraph(t,e,n,r){return parseBody(request("/api/graph/getLocalGraph",{id:e,k:t,conf:n,reqId:r}))}async function getGraph(t,e,n){return parseBody(request("/api/graph/getGraph",{k:t,conf:e,reqId:n}))}async function searchDocs(t){return parseBody(request("/api/filetree/searchDocs",{k:t}))}async function searchBlock(t){return parseBody(request("/api/search/searchBlock",{query:t}))}async function searchTemplate(t){return parseBody(request("/api/search/searchTemplate",{k:t}))}async function createDocWithMd(t,e,n){return parseBody(request("/api/filetree/createDocWithMd",{notebook:t,path:e,markdown:n}))}async function docSaveAsTemplate(t,e=!1){return parseBody(request("/api/template/docSaveAsTemplate",{id:t,overwrite:e}))}async function render(t){return parseBody(request("/api/template/render",t))}async function insertBlock(t,e,n){let r="/api/block/insertBlock";return parseBody(request(r,n={previousID:t,dataType:e,data:n}))}async function prependBlock(t,e,n){let r="/api/block/prependBlock";return parseBody(request(r,n={parentID:t,dataType:e,data:n}))}async function appendBlock(t,e,n){let r="/api/block/appendBlock";return parseBody(request(r,n={parentID:t,dataType:e,data:n}))}async function updateBlock(t,e,n){let r="/api/block/updateBlock";return parseBody(request(r,n={id:t,dataType:e,data:n}))}async function deleteBlock(t){return parseBody(request("/api/block/deleteBlock",{id:t}))}async function getSysFonts(){return parseBody(request("/api/system/getSysFonts",null))}async function getFile(t){const e=await fetch("/api/file/getFile",{method:"POST",headers:{Authorization:`Token ${config().token}`},body:JSON.stringify({path:t})});return 200===e.status?e:null}async function putFile(t,e,n=!1,r=Date.now()){let i=new Blob([e]),o=new File([i],t.split("/").pop()),a=new FormData;a.append("path",t),a.append("file",o),a.append("isDir",String(n)),a.append("modTime",String(r));const s=await fetch("/api/file/putFile",{body:a,method:"POST",headers:{Authorization:`Token ${config().token}`}});return 200===s.status?await s.json():null}Reflect2=Reflect$1||(Reflect$1={}),function(t){var e="object"==typeof commonjsGlobal?commonjsGlobal:"object"==typeof self?self:"object"==typeof this?this:Function("return this;")(),n=r(Reflect2);function r(t,e){return function(n,r){"function"!=typeof t[n]&&Object.defineProperty(t,n,{configurable:!0,writable:!0,value:r}),e&&e(n,r)}}void 0===e.Reflect?e.Reflect=Reflect2:n=r(e.Reflect,n),function(t){var e=Object.prototype.hasOwnProperty,n="function"==typeof Symbol,r=n&&void 0!==Symbol.toPrimitive?Symbol.toPrimitive:"@@toPrimitive",i=n&&void 0!==Symbol.iterator?Symbol.iterator:"@@iterator",o="function"==typeof Object.create,a={__proto__:[]}instanceof Array,s=!o&&!a,c={create:o?function(){return rt(Object.create(null))}:a?function(){return rt({__proto__:null})}:function(){return rt({})},has:s?function(t,n){return e.call(t,n)}:function(t,e){return e in t},get:s?function(t,n){return e.call(t,n)?t[n]:void 0}:function(t,e){return t[e]}},u=Object.getPrototypeOf(Function),l="object"==typeof process&&process.env&&"true"===process.env.REFLECT_METADATA_USE_MAP_POLYFILL,d=l||"function"!=typeof Map||"function"!=typeof Map.prototype.entries?tt():Map,p=l||"function"!=typeof Set||"function"!=typeof Set.prototype.entries?et():Set,f=new(l||"function"!=typeof WeakMap?nt():WeakMap);function h(t,e,n,r){if(R(n)){if(!V(t))throw new TypeError;if(!Y(e))throw new TypeError;return S(t,e)}if(!V(t))throw new TypeError;if(!F(e))throw new TypeError;if(!F(r)&&!R(r)&&!x(r))throw new TypeError;return x(r)&&(r=void 0),E(t,e,n=G(n),r)}function g(t,e){function n(n,r){if(!F(n))throw new TypeError;if(!R(r)&&!H(r))throw new TypeError;D(t,e,n,r)}return n}function y(t,e,n,r){if(!F(n))throw new TypeError;return R(r)||(r=G(r)),D(t,e,n,r)}function _(t,e,n){if(!F(e))throw new TypeError;return R(n)||(n=G(n)),N(t,e,n)}function v(t,e,n){if(!F(e))throw new TypeError;return R(n)||(n=G(n)),P(t,e,n)}function m(t,e,n){if(!F(e))throw new TypeError;return R(n)||(n=G(n)),B(t,e,n)}function b(t,e,n){if(!F(e))throw new TypeError;return R(n)||(n=G(n)),k(t,e,n)}function A(t,e){if(!F(t))throw new TypeError;return R(e)||(e=G(e)),C(t,e)}function w(t,e){if(!F(t))throw new TypeError;return R(e)||(e=G(e)),O(t,e)}function T(t,e,n){if(!F(e))throw new TypeError;R(n)||(n=G(n));var r=I(e,n,!1);if(R(r))return!1;if(!r.delete(t))return!1;if(r.size>0)return!0;var i=f.get(e);return i.delete(n),i.size>0||f.delete(e),!0}function S(t,e){for(var n=t.length-1;n>=0;--n){var r=(0,t[n])(e);if(!R(r)&&!x(r)){if(!Y(r))throw new TypeError;e=r}}return e}function E(t,e,n,r){for(var i=t.length-1;i>=0;--i){var o=(0,t[i])(e,n,r);if(!R(o)&&!x(o)){if(!F(o))throw new TypeError;r=o}}return r}function I(t,e,n){var r=f.get(t);if(R(r)){if(!n)return;r=new d,f.set(t,r)}var i=r.get(e);if(R(i)){if(!n)return;i=new d,r.set(e,i)}return i}function N(t,e,n){if(P(t,e,n))return!0;var r=X(e);return!x(r)&&N(t,r,n)}function P(t,e,n){var r=I(e,n,!1);return!R(r)&&$(r.has(t))}function B(t,e,n){if(P(t,e,n))return k(t,e,n);var r=X(e);return x(r)?void 0:B(t,r,n)}function k(t,e,n){var r=I(e,n,!1);if(!R(r))return r.get(t)}function D(t,e,n,r){I(n,r,!0).set(t,e)}function C(t,e){var n=O(t,e),r=X(t);if(null===r)return n;var i=C(r,e);if(i.length<=0)return n;if(n.length<=0)return i;for(var o=new p,a=[],s=0,c=n;s<c.length;s++){var u=c[s];o.has(u)||(o.add(u),a.push(u))}for(var l=0,d=i;l<d.length;l++)u=d[l],o.has(u)||(o.add(u),a.push(u));return a}function O(t,e){var n=[],r=I(t,e,!1);if(R(r))return n;for(var i=J(r.keys()),o=0;;){var a=Q(i);if(!a)return n.length=o,n;var s=z(a);try{n[o]=s}catch(c){try{Z(i)}finally{throw c}}o++}}function M(t){if(null===t)return 1;switch(typeof t){case"undefined":return 0;case"boolean":return 2;case"string":return 3;case"symbol":return 4;case"number":return 5;case"object":return null===t?1:6;default:return 6}}function R(t){return void 0===t}function x(t){return null===t}function L(t){return"symbol"==typeof t}function F(t){return"object"==typeof t?null!==t:"function"==typeof t}function q(t,e){switch(M(t)){case 0:case 1:case 2:case 3:case 4:case 5:return t}var n=3===e?"string":5===e?"number":"default",i=K(t,r);if(void 0!==i){var o=i.call(t,n);if(F(o))throw new TypeError;return o}return j(t,"default"===n?"number":n)}function j(t,e){if("string"===e){var n=t.toString;if(W(n)&&!F(i=n.call(t)))return i;if(W(r=t.valueOf)&&!F(i=r.call(t)))return i}else{var r;if(W(r=t.valueOf)&&!F(i=r.call(t)))return i;var i,o=t.toString;if(W(o)&&!F(i=o.call(t)))return i}throw new TypeError}function $(t){return!!t}function U(t){return""+t}function G(t){var e=q(t,3);return L(e)?e:U(e)}function V(t){return Array.isArray?Array.isArray(t):t instanceof Object?t instanceof Array:"[object Array]"===Object.prototype.toString.call(t)}function W(t){return"function"==typeof t}function Y(t){return"function"==typeof t}function H(t){switch(M(t)){case 3:case 4:return!0;default:return!1}}function K(t,e){var n=t[e];if(null!=n){if(!W(n))throw new TypeError;return n}}function J(t){var e=K(t,i);if(!W(e))throw new TypeError;var n=e.call(t);if(!F(n))throw new TypeError;return n}function z(t){return t.value}function Q(t){var e=t.next();return!e.done&&e}function Z(t){var e=t.return;e&&e.call(t)}function X(t){var e=Object.getPrototypeOf(t);if("function"!=typeof t||t===u)return e;if(e!==u)return e;var n=t.prototype,r=n&&Object.getPrototypeOf(n);if(null==r||r===Object.prototype)return e;var i=r.constructor;return"function"!=typeof i||i===t?e:i}function tt(){var t={},e=[],n=function(){function t(t,e,n){this._index=0,this._keys=t,this._values=e,this._selector=n}return t.prototype["@@iterator"]=function(){return this},t.prototype[i]=function(){return this},t.prototype.next=function(){var t=this._index;if(t>=0&&t<this._keys.length){var n=this._selector(this._keys[t],this._values[t]);return t+1>=this._keys.length?(this._index=-1,this._keys=e,this._values=e):this._index++,{value:n,done:!1}}return{value:void 0,done:!0}},t.prototype.throw=function(t){throw this._index>=0&&(this._index=-1,this._keys=e,this._values=e),t},t.prototype.return=function(t){return this._index>=0&&(this._index=-1,this._keys=e,this._values=e),{value:t,done:!0}},t}();return function(){function e(){this._keys=[],this._values=[],this._cacheKey=t,this._cacheIndex=-2}return Object.defineProperty(e.prototype,"size",{get:function(){return this._keys.length},enumerable:!0,configurable:!0}),e.prototype.has=function(t){return this._find(t,!1)>=0},e.prototype.get=function(t){var e=this._find(t,!1);return e>=0?this._values[e]:void 0},e.prototype.set=function(t,e){var n=this._find(t,!0);return this._values[n]=e,this},e.prototype.delete=function(e){var n=this._find(e,!1);if(n>=0){for(var r=this._keys.length,i=n+1;i<r;i++)this._keys[i-1]=this._keys[i],this._values[i-1]=this._values[i];return this._keys.length--,this._values.length--,e===this._cacheKey&&(this._cacheKey=t,this._cacheIndex=-2),!0}return!1},e.prototype.clear=function(){this._keys.length=0,this._values.length=0,this._cacheKey=t,this._cacheIndex=-2},e.prototype.keys=function(){return new n(this._keys,this._values,r)},e.prototype.values=function(){return new n(this._keys,this._values,o)},e.prototype.entries=function(){return new n(this._keys,this._values,a)},e.prototype["@@iterator"]=function(){return this.entries()},e.prototype[i]=function(){return this.entries()},e.prototype._find=function(t,e){return this._cacheKey!==t&&(this._cacheIndex=this._keys.indexOf(this._cacheKey=t)),this._cacheIndex<0&&e&&(this._cacheIndex=this._keys.length,this._keys.push(t),this._values.push(void 0)),this._cacheIndex},e}();function r(t,e){return t}function o(t,e){return e}function a(t,e){return[t,e]}}function et(){return function(){function t(){this._map=new d}return Object.defineProperty(t.prototype,"size",{get:function(){return this._map.size},enumerable:!0,configurable:!0}),t.prototype.has=function(t){return this._map.has(t)},t.prototype.add=function(t){return this._map.set(t,t),this},t.prototype.delete=function(t){return this._map.delete(t)},t.prototype.clear=function(){this._map.clear()},t.prototype.keys=function(){return this._map.keys()},t.prototype.values=function(){return this._map.values()},t.prototype.entries=function(){return this._map.entries()},t.prototype["@@iterator"]=function(){return this.keys()},t.prototype[i]=function(){return this.keys()},t}()}function nt(){var t=16,n=c.create(),r=i();return function(){function t(){this._key=i()}return t.prototype.has=function(t){var e=o(t,!1);return void 0!==e&&c.has(e,this._key)},t.prototype.get=function(t){var e=o(t,!1);return void 0!==e?c.get(e,this._key):void 0},t.prototype.set=function(t,e){return o(t,!0)[this._key]=e,this},t.prototype.delete=function(t){var e=o(t,!1);return void 0!==e&&delete e[this._key]},t.prototype.clear=function(){this._key=i()},t}();function i(){var t;do{t="@@WeakMap@@"+u()}while(c.has(n,t));return n[t]=!0,t}function o(t,n){if(!e.call(t,r)){if(!n)return;Object.defineProperty(t,r,{value:c.create()})}return t[r]}function a(t,e){for(var n=0;n<e;++n)t[n]=255*Math.random()|0;return t}function s(t){return"function"==typeof Uint8Array?"undefined"!=typeof crypto?crypto.getRandomValues(new Uint8Array(t)):"undefined"!=typeof msCrypto?msCrypto.getRandomValues(new Uint8Array(t)):a(new Uint8Array(t),t):a(new Array(t),t)}function u(){var e=s(t);e[6]=79&e[6]|64,e[8]=191&e[8]|128;for(var n="",r=0;r<t;++r){var i=e[r];4!==r&&6!==r&&8!==r||(n+="-"),i<16&&(n+="0"),n+=i.toString(16).toLowerCase()}return n}}function rt(t){return t.__=void 0,delete t.__,t}t("decorate",h),t("metadata",g),t("defineMetadata",y),t("hasMetadata",_),t("hasOwnMetadata",v),t("getMetadata",m),t("getOwnMetadata",b),t("getMetadataKeys",A),t("getOwnMetadataKeys",w),t("deleteMetadata",T)}(n)}();const language=null==(_a=window.theme)?void 0:_a.languageMode;async function pushMsg(t=null,e=null,n=7e3){return parseBody(request("/api/notification/pushMsg",{msg:t?t[language]||t.other:e,timeout:n}))}async function pushErrMsg(t=null,e=null,n=7e3){return parseBody(request("/api/notification/pushErrMsg",{msg:t?t[language]||t.other:e,timeout:n}))}async function setStorageVal(t,e){return parseBody(request("/api/storage/setLocalStorageVal",{app:genUUID(),key:t,val:e}))}async function getLocalStorage(){return parseBody(request("/api/storage/getLocalStorage",null))}const serverApi=Object.freeze(Object.defineProperty({__proto__:null,appendBlock:appendBlock,closeNotebook:closeNotebook,createDocWithMd:createDocWithMd,createNotebook:createNotebook,deleteBlock:deleteBlock,docSaveAsTemplate:docSaveAsTemplate,exportMdContent:exportMdContent,getAnchor:getAnchor,getBacklink:getBacklink,getBlockAttrs:getBlockAttrs,getBlockBreadcrumb:getBlockBreadcrumb,getBlockByID:getBlockByID,getBlockKramdown:getBlockKramdown,getDoc:getDoc,getDocOutline:getDocOutline,getFile:getFile,getFocusedDoc:getFocusedDoc,getGraph:getGraph,getHPathByID:getHPathByID,getHPathByPath:getHPathByPath,getLocalGraph:getLocalGraph,getLocalStorage:getLocalStorage,getNotebookConf:getNotebookConf,getSysFonts:getSysFonts,getTag:getTag,insertBlock:insertBlock,listDocsByPath:listDocsByPath,lsNotebooks:lsNotebooks,moveDoc:moveDoc,openNotebook:openNotebook,parseBody:parseBody,prependBlock:prependBlock,pushErrMsg:pushErrMsg,pushMsg:pushMsg,putFile:putFile,removeDoc:removeDoc,removeNotebook:removeNotebook,renameDoc:renameDoc,renameNotebook:renameNotebook,render:render,request:request,searchBlock:searchBlock,searchDocs:searchDocs,searchEmbedBlock:searchEmbedBlock,searchTemplate:searchTemplate,setBlockAttrs:setBlockAttrs,setNotebookConf:setNotebookConf,setStorageVal:setStorageVal,sql:sql,transactions:transactions,updateBlock:updateBlock},Symbol.toStringTag,{value:"Module"})),PLUGIN_SYSTEM_AUTO_UPDATE="plugin_system_auto_update",defaultConfig={[PLUGIN_SYSTEM_AUTO_UPDATE]:!0};var __defProp$2=Object.defineProperty,__getOwnPropDesc$2=Object.getOwnPropertyDescriptor,__decorateClass$2=(t,e,n,r)=>{for(var i,o=r>1?void 0:r?__getOwnPropDesc$2(e,n):e,a=t.length-1;a>=0;a--)(i=t[a])&&(o=(r?i(e,n,o):i(o))||o);return r&&o&&__defProp$2(e,n,o),o};let StorageManager=class{constructor(){this.config=Object.assign({},defaultConfig),this.initialized=!1}get(t){return this.config[t]}async set(t,e){return this.config[t]=e,setStorageVal(t,e)}async initStorage(){if(this.initialized)return this;const t=await getLocalStorage(),e=Object.keys(defaultConfig);for(const n of e)void 0!==t[n]?this.config[n]=t[n]:await setStorageVal(n,defaultConfig[n]);return this.initialized=!0,this}};StorageManager=__decorateClass$2([injectable()],StorageManager);class Plugin{onload(){}onunload(){}}function insertBefore(t,e){return t.insertAdjacentElement("beforebegin",e)}function insertAfter(t,e){return t.insertAdjacentElement("afterend",e)}function addToolbarLeft(t){var e;const n=null==(e=document.getElementById("toolbar"))?void 0:e.getElementsByClassName("fn__ellipsis");n&&insertBefore(n[0],t)}function addToolbarRight(t){var e;const n=null==(e=document.getElementById("toolbar"))?void 0:e.getElementsByClassName("fn__ellipsis");n&&insertAfter(n[0],t)}const clientApi=Object.freeze(Object.defineProperty({__proto__:null,addToolbarLeft:addToolbarLeft,addToolbarRight:addToolbarRight},Symbol.toStringTag,{value:"Module"})),menu=null==(_c=null==(_b=window.siyuan)?void 0:_b.menus)?void 0:_c.menu;class Menu{constructor(t){if(!menu)throw Error("Siyuan internal menu not found!");if(!t)throw Error("Menu must has an id, got empty or undefined!");menu.remove(),menu.element.setAttribute("data-name",t)}addItem(t){return menu.append(t.element),this}addSeparator(){return this.addItem(new MenuItem({type:"separator"})),this}showAtMouseEvent(t){return menu.popup({x:t.clientX,y:t.clientY}),this}showAtPosition(t){return menu.popup({x:t.x,y:t.y}),this}close(){menu.remove()}}class MenuItem{constructor(t){if(this.element=document.createElement("button"),t.disabled&&this.element.setAttribute("disabled","disabled"),"separator"===t.type)return void this.element.classList.add("b3-menu__separator");this.element.classList.add("b3-menu__item"),t.current&&this.element.classList.add("b3-menu__item--selected"),t.click&&this.element.addEventListener("click",(e=>{this.element.getAttribute("disabled")||(t.click(this.element),e.preventDefault(),e.stopImmediatePropagation(),e.stopPropagation(),window.siyuan.menus.menu.remove())}));let e=`<span class="b3-menu__label">${t.label}</span>`;if(e=t.iconHTML?t.iconHTML+e:`<svg class="b3-menu__icon${["HTML (SiYuan)",window.siyuan.languages.template].includes(t.label)?" ft__error":""}" style="${"iconClose"===t.icon?"height:10px;":""}"><use xlink:href="#${t.icon||""}"></use></svg>${e}`,t.action&&(e+=`<svg class="b3-menu__action"><use xlink:href="#${t.action}"></use></svg>`),t.id&&this.element.setAttribute("data-id",t.id),"readonly"===t.type&&this.element.classList.add("b3-menu__item--readonly"),this.element.innerHTML=e,t.bind&&(this.element.classList.add("b3-menu__item--custom"),t.bind(this.element)),t.submenu){const e=document.createElement("div");e.classList.add("b3-menu__submenu"),t.submenu.forEach((t=>{e.append(new MenuItem(t).element)})),this.element.insertAdjacentHTML("beforeend",'<svg class="b3-menu__icon b3-menu__icon--arrow"><use xlink:href="#iconRight"></use></svg>'),this.element.append(e)}}}class MenuSeparator{}class Dialog{constructor(t){this.disableClose=t.disableClose,this.id=genUUID(),window.siyuan.dialogs.push(this),this.destroyCallback=t.destroyCallback,this.element=document.createElement("div"),this.element.innerHTML=`<div class="b3-dialog">\n<div class="b3-dialog__scrim"${t.transparent?'style="background-color:transparent"':""}></div>\n<div class="b3-dialog__container" style="width:${t.width||"auto"}">\n  <svg class="b3-dialog__close fn__a${this.disableClose?" fn__none":""}"><use xlink:href="#iconClose"></use></svg>\n  <div class="b3-dialog__header${t.title?"":" fn__none"}" onselectstart="return false;">${t.title||""}</div>\n  <div style="height:${t.height||"auto"}">${t.content}</div>\n</div></div>`,this.element.querySelector(".b3-dialog__scrim").addEventListener("click",(t=>{this.disableClose||this.destroy(),t.preventDefault(),t.stopPropagation(),window.siyuan.menus.menu.remove()})),this.disableClose||this.element.querySelector(".b3-dialog__close").addEventListener("click",(t=>{this.destroy(),t.preventDefault(),t.stopPropagation()})),document.body.append(this.element),t.disableAnimation?this.element.classList.add("b3-dialog--open"):setTimeout((()=>{this.element.classList.add("b3-dialog--open")})),window.siyuan.menus.menu.remove()}destroy(){this.element.remove(),window.siyuan.menus.menu.remove(),this.destroyCallback&&this.destroyCallback(),window.siyuan.dialogs.find(((t,e)=>{if(t.id===this.id)return window.siyuan.dialogs.splice(e,1),!0}))}bindInput(t,e){t.focus(),t.addEventListener("keydown",(t=>{if(!t.isComposing)return"Escape"===t.key?(this.destroy(),t.preventDefault(),void t.stopPropagation()):void("Enter"===t.key&&e&&(e(),t.preventDefault()));t.preventDefault()}))}}function noop(){}function run(t){return t()}function blank_object(){return Object.create(null)}function run_all(t){t.forEach(run)}function is_function(t){return"function"==typeof t}function safe_not_equal(t,e){return t!=t?e==e:t!==e||t&&"object"==typeof t||"function"==typeof t}function is_empty(t){return 0===Object.keys(t).length}function append(t,e){t.appendChild(e)}function insert(t,e,n){t.insertBefore(e,n||null)}function detach(t){t.parentNode&&t.parentNode.removeChild(t)}function destroy_each(t,e){for(let n=0;n<t.length;n+=1)t[n]&&t[n].d(e)}function element(t){return document.createElement(t)}function text(t){return document.createTextNode(t)}function space(){return text(" ")}function empty(){return text("")}function listen(t,e,n,r){return t.addEventListener(e,n,r),()=>t.removeEventListener(e,n,r)}function attr(t,e,n){null==n?t.removeAttribute(e):t.getAttribute(e)!==n&&t.setAttribute(e,n)}function children(t){return Array.from(t.childNodes)}function set_data(t,e){e=""+e,t.wholeText!==e&&(t.data=e)}function set_style(t,e,n,r){null===n?t.style.removeProperty(e):t.style.setProperty(e,n,r?"important":"")}let current_component;function set_current_component(t){current_component=t}function get_current_component(){if(!current_component)throw new Error("Function called outside component initialization");return current_component}function onMount(t){get_current_component().$$.on_mount.push(t)}const dirty_components=[],binding_callbacks=[],render_callbacks=[],flush_callbacks=[],resolved_promise=Promise.resolve();let update_scheduled=!1;function schedule_update(){update_scheduled||(update_scheduled=!0,resolved_promise.then(flush))}function add_render_callback(t){render_callbacks.push(t)}const seen_callbacks=new Set;let flushidx=0;function flush(){if(0!==flushidx)return;const t=current_component;do{try{for(;flushidx<dirty_components.length;){const t=dirty_components[flushidx];flushidx++,set_current_component(t),update(t.$$)}}catch(e){throw dirty_components.length=0,flushidx=0,e}for(set_current_component(null),dirty_components.length=0,flushidx=0;binding_callbacks.length;)binding_callbacks.pop()();for(let t=0;t<render_callbacks.length;t+=1){const e=render_callbacks[t];seen_callbacks.has(e)||(seen_callbacks.add(e),e())}render_callbacks.length=0}while(dirty_components.length);for(;flush_callbacks.length;)flush_callbacks.pop()();update_scheduled=!1,seen_callbacks.clear(),set_current_component(t)}function update(t){if(null!==t.fragment){t.update(),run_all(t.before_update);const e=t.dirty;t.dirty=[-1],t.fragment&&t.fragment.p(t.ctx,e),t.after_update.forEach(add_render_callback)}}const outroing=new Set;let outros;function transition_in(t,e){t&&t.i&&(outroing.delete(t),t.i(e))}function transition_out(t,e,n,r){if(t&&t.o){if(outroing.has(t))return;outroing.add(t),outros.c.push((()=>{outroing.delete(t),r&&(n&&t.d(1),r())})),t.o(e)}else r&&r()}function create_component(t){t&&t.c()}function mount_component(t,e,n,r){const{fragment:i,after_update:o}=t.$$;i&&i.m(e,n),r||add_render_callback((()=>{const e=t.$$.on_mount.map(run).filter(is_function);t.$$.on_destroy?t.$$.on_destroy.push(...e):run_all(e),t.$$.on_mount=[]})),o.forEach(add_render_callback)}function destroy_component(t,e){const n=t.$$;null!==n.fragment&&(run_all(n.on_destroy),n.fragment&&n.fragment.d(e),n.on_destroy=n.fragment=null,n.ctx=[])}function make_dirty(t,e){-1===t.$$.dirty[0]&&(dirty_components.push(t),schedule_update(),t.$$.dirty.fill(0)),t.$$.dirty[e/31|0]|=1<<e%31}function init(t,e,n,r,i,o,a,s=[-1]){const c=current_component;set_current_component(t);const u=t.$$={fragment:null,ctx:[],props:o,update:noop,not_equal:i,bound:blank_object(),on_mount:[],on_destroy:[],on_disconnect:[],before_update:[],after_update:[],context:new Map(e.context||(c?c.$$.context:[])),callbacks:blank_object(),dirty:s,skip_bound:!1,root:e.target||c.$$.root};a&&a(u.root);let l=!1;if(u.ctx=n?n(t,e.props||{},((e,n,...r)=>{const o=r.length?r[0]:n;return u.ctx&&i(u.ctx[e],u.ctx[e]=o)&&(!u.skip_bound&&u.bound[e]&&u.bound[e](o),l&&make_dirty(t,e)),n})):[],u.update(),l=!0,run_all(u.before_update),u.fragment=!!r&&r(u.ctx),e.target){if(e.hydrate){const t=children(e.target);u.fragment&&u.fragment.l(t),t.forEach(detach)}else u.fragment&&u.fragment.c();e.intro&&transition_in(t.$$.fragment),mount_component(t,e.target,e.anchor,e.customElement),flush()}set_current_component(c)}class SvelteComponent{$destroy(){destroy_component(this,1),this.$destroy=noop}$on(t,e){if(!is_function(e))return noop;const n=this.$$.callbacks[t]||(this.$$.callbacks[t]=[]);return n.push(e),()=>{const t=n.indexOf(e);-1!==t&&n.splice(t,1)}}$set(t){this.$$set&&!is_empty(t)&&(this.$$.skip_bound=!0,this.$$set(t),this.$$.skip_bound=!1)}}const TYPES={StorageManager:Symbol.for("StorageManager"),StorageManagerProvider:Symbol.for("StorageManagerProvider"),PluginSystem:Symbol.for("PluginSystem"),PluginSystemLocalManager:Symbol.for("PluginSystemLocalManager")};function get_each_context(t,e,n){const r=t.slice();return r[3]=e[n],r[4]=e,r[5]=n,r}function create_each_block(t){let e,n,r,i,o,a,s,c,u,l,d,p,f,h=t[3].label+"",g=t[3].tip+"";function y(){t[1].call(l,t[4],t[5])}return{c(){e=element("label"),n=element("div"),r=text(h),i=space(),o=element("div"),a=text(g),s=space(),c=element("span"),u=space(),l=element("input"),d=space(),attr(o,"class","b3-label__text"),attr(n,"class","fn__flex-1"),attr(c,"class","fn__space"),attr(l,"class","b3-switch fn__flex-center"),attr(l,"id","fullWidth"),attr(l,"type","checkbox"),attr(e,"class","fn__flex b3-label")},m(h,g){insert(h,e,g),append(e,n),append(n,r),append(n,i),append(n,o),append(o,a),append(e,s),append(e,c),append(e,u),append(e,l),l.checked=t[3].checked,append(e,d),p||(f=[listen(l,"change",y),listen(l,"change",(function(){is_function(t[3].onChange)&&t[3].onChange.apply(this,arguments)}))],p=!0)},p(e,n){t=e,1&n&&h!==(h=t[3].label+"")&&set_data(r,h),1&n&&g!==(g=t[3].tip+"")&&set_data(a,g),1&n&&(l.checked=t[3].checked)},d(t){t&&detach(e),p=!1,run_all(f)}}}function create_fragment$1(t){let e,n=t[0],r=[];for(let i=0;i<n.length;i+=1)r[i]=create_each_block(get_each_context(t,n,i));return{c(){for(let t=0;t<r.length;t+=1)r[t].c();e=empty()},m(t,n){for(let e=0;e<r.length;e+=1)r[e].m(t,n);insert(t,e,n)},p(t,[i]){if(1&i){let o;for(n=t[0],o=0;o<n.length;o+=1){const a=get_each_context(t,n,o);r[o]?r[o].p(a,i):(r[o]=create_each_block(a),r[o].c(),r[o].m(e.parentNode,e))}for(;o<r.length;o+=1)r[o].d(1);r.length=n.length}},i:noop,o:noop,d(t){destroy_each(r,t),t&&detach(e)}}}function instance(t,e,n){const r=container.get(TYPES.StorageManager);let i=[{label:"",tip:"",checked:!0,type:"chcekbox",onChange:t=>{r.set(PLUGIN_SYSTEM_AUTO_UPDATE,t.target.checked)}}];return onMount((()=>{const t=r.get(PLUGIN_SYSTEM_AUTO_UPDATE);n(0,i[0].checked=t,i)})),[i,function(t,e){t[e].checked=this.checked,n(0,i)}]}class Setting_common extends SvelteComponent{constructor(t){super(),init(this,t,instance,create_fragment$1,safe_not_equal,{})}}function create_fragment(t){let e,n,r,i,o,a,s,c;return s=new Setting_common({}),{c(){e=element("main"),n=element("div"),r=element("div"),i=element("ul"),i.innerHTML='<li data-name="editor" class="b3-list-item--focus b3-list-item b3-list-item--big"><svg class="b3-list-item__graphic"><use xlink:href="#iconEdit"></use></svg><span class="b3-list-item__text"></span></li>',o=space(),a=element("div"),create_component(s.$$.fragment),attr(i,"class","b3-tab-bar b3-list b3-list--background"),set_style(i,"height","unset",1),attr(a,"class","b3-tab-container"),set_style(a,"height","unset",1),attr(a,"data-name","setting"),attr(r,"class","fn__flex-1 fn__flex config__panel"),attr(n,"class","fn__flex-column"),set_style(n,"border-radius","4px"),set_style(n,"overflow","hidden"),set_style(n,"position","relative")},m(t,u){insert(t,e,u),append(e,n),append(n,r),append(r,i),append(r,o),append(r,a),mount_component(s,a,null),c=!0},p:noop,i(t){c||(transition_in(s.$$.fragment,t),c=!0)},o(t){transition_out(s.$$.fragment,t),c=!1},d(t){t&&detach(e),destroy_component(s)}}}class Setting extends SvelteComponent{constructor(t){super(),init(this,t,null,create_fragment,safe_not_equal,{})}}class InternalSettingPlugin extends Plugin{constructor(){super()}onload(){const t=document.createElement("button");t.classList.add("toolbar__item"),t.insertAdjacentHTML("beforeend",'<svg><use xlink:href="#iconSettings"></use></svg>'),t.addEventListener("click",(t=>{new Menu("internalSettingButton").addItem(new MenuItem({label:"",icon:"iconEdit",click:()=>showSettingDialog()})).addSeparator().addItem(new MenuItem({label:"",icon:"iconRefresh",click:()=>window.location.reload()})).showAtMouseEvent(t),t.stopPropagation()})),addToolbarRight(t)}onunload(){console.log("InternalSettingPluginUnload")}}function showSettingDialog(){new Dialog({title:"",content:'<div id="plugin-settings"></div>',width:"90vw",height:"50vh"}),setTimeout((()=>{new Setting({target:document.getElementById("plugin-settings")})}))}const internalPlugins=[{key:"setting",name:"",plugin:InternalSettingPlugin}],internal=Object.freeze(Object.defineProperty({__proto__:null,Dialog:Dialog,Menu:Menu,MenuItem:MenuItem,MenuSeparator:MenuSeparator,internalPlugins:internalPlugins},Symbol.toStringTag,{value:"Module"})),apiGenerate=()=>({clientApi:clientApi,serverApi:serverApi,...internal});class BaseComponent{}const modules={Plugin:Plugin,BaseComponent:BaseComponent},fs$1=require("fs"),path$1=require("path"),MANIFEST="manifest.json",SCRIPT="main.js",scanPlugins=async t=>new Promise(((e,n)=>{fs$1.readdir(t,((r,i)=>{r?n(r):e(i.map((e=>path$1.resolve(t,e))))}))})),getFileContent=async t=>new Promise(((e,n)=>{fs$1.readFile(t,((t,r)=>{if(!t)return e(r.toString("utf8"));n(t)}))})),getManifest=async t=>{const e=await getFileContent(t);try{return JSON.parse(e)}catch(n){error("loading manifest: "+t,n)}},getScript=async t=>await getFileContent(t),getAllPlugins=async()=>{const t=await scanPlugins(path$1.join(SIYUAN_DATA_PATH,PLUGIN_FOLDER));if(!t||!t.length)return void log("No plugin found in "+path$1.join(SIYUAN_DATA_PATH,PLUGIN_FOLDER));const e=[];for(const n of t){log("Loading plugin: "+n);const[t,r]=await Promise.all([getManifest(path$1.join(n,MANIFEST)),getScript(path$1.join(n,SCRIPT))]);e.push({...t,script:r})}return e};let components;class PluginLoader{constructor(){this.plugins=new Map}async loadAllInternalPlugins(){internalPlugins.forEach((t=>{const e=new t.plugin;if(!(e instanceof Plugin))throw new Error(`Failed to load plugin ${t.name}`);log(`Load internal plugin: ${t.key}(${t.name})`),e.onload(),this.plugins.set(t.key,e)}))}async loadAllLocalPlugins(){const t=await getAllPlugins();if(t)for(const e of t)await this.loadPlugin(e)}async loadPlugin(plugin){components||this.generateRequiredModules();const exports={},module={exports:exports};function run(script,name){return eval("(function anonymous(require,module,exports){".concat(script,"\n})\n//# sourceURL=").concat(name,"\n"))}const __require=t=>{if(components[t])return components[t];throw new Error(`module ${t} not found`)},pluginName=plugin.name;let pluginConstructor;if(run(plugin.script,plugin.name)(__require,module,exports),!(pluginConstructor=(module.exports||exports).default||module.exports))throw new Error(`Failed to load plugin ${pluginName}. No exports detected.`);const plug=new pluginConstructor;if(!(plug instanceof Plugin))throw new Error(`Failed to load plugin ${pluginName}`);plug.onload(),this.plugins.set(pluginName,plug)}async unloadPlugin(t){const e=this.plugins.get(t);e&&(await e.onunload(),this.plugins.delete(t))}generateRequiredModules(){components={siyuan:{...modules,...apiGenerate()}}}}var __defProp$1=Object.defineProperty,__getOwnPropDesc$1=Object.getOwnPropertyDescriptor,__decorateClass$1=(t,e,n,r)=>{for(var i,o=r>1?void 0:r?__getOwnPropDesc$1(e,n):e,a=t.length-1;a>=0;a--)(i=t[a])&&(o=(r?i(e,n,o):i(o))||o);return r&&o&&__defProp$1(e,n,o),o},__decorateParam$1=(t,e)=>(n,r)=>e(n,r,t);let PluginSystem=class{constructor(t,e){this.pluginLoader=new PluginLoader,this.pslm=t,this.storageManagerProvider=e}async init(){return this.storageManager=await this.storageManagerProvider(),this.pluginLoader.loadAllInternalPlugins(),this.pluginLoader.loadAllLocalPlugins(),this.pslm.localCacheInit(),this}};PluginSystem=__decorateClass$1([injectable(),__decorateParam$1(0,inject(TYPES.PluginSystemLocalManager)),__decorateParam$1(1,inject(TYPES.StorageManagerProvider))],PluginSystem);var __defProp=Object.defineProperty,__getOwnPropDesc=Object.getOwnPropertyDescriptor,__decorateClass=(t,e,n,r)=>{for(var i,o=r>1?void 0:r?__getOwnPropDesc(e,n):e,a=t.length-1;a>=0;a--)(i=t[a])&&(o=(r?i(e,n,o):i(o))||o);return r&&o&&__defProp(e,n,o),o},__decorateParam=(t,e)=>(n,r)=>e(n,r,t);const fs=require("fs"),path=require("path"),pluginScriptPosition=PLUGIN_SYS_ABS_PATH;let PluginSystemLocalManager=class{constructor(t){this.storageMangager=t}saveToLocal(t,e){return new Promise(((n,r)=>{const{writeFile:i}=fs,{Buffer:o}=require("buffer"),a=new Uint8Array(o.from(e));i(t,a,(t=>{if(t)return r(t);n("The file has been saved!")}))}))}createFile(t){return new Promise(((e,n)=>{fs.mkdir(path.dirname(t),{recursive:!0},(t=>{if(t)return n(t);e("Directory created successfully!")}))}))}async localCacheInit(){try{return fs.statSync(pluginScriptPosition),void this.delayAutoUpgrade()}catch(e){log("Plugin system not found")}const t=window.siyuanPluginScript;t&&(await this.createFile(pluginScriptPosition),await this.saveToLocal(pluginScriptPosition,t),this.delayAutoUpgrade())}delayAutoUpgrade(){setTimeout((()=>{this.storageMangager.get(PLUGIN_SYSTEM_AUTO_UPDATE)?this.tryUpgrade():log("Auto Update skipped")}),1e3)}async tryUpgrade(){log("Try getting online version");const t=await this.getOnlineVersion();t!==VERSION?(log("Online Version: "+t+", local version: "+VERSION),log("Downloading new version of Plugin System"),this.upgrade()):log("Version is "+VERSION+", OK")}async getOnlineVersion(){return fetch(VERSION_URL,{cache:"no-cache"}).then((t=>t.text()))}async upgrade(){const t=await fetch(SCRIPT_URL,{cache:"no-cache"}).then((t=>t.text()));t&&(await this.createFile(pluginScriptPosition),await this.saveToLocal(pluginScriptPosition,t),log("Plugin system upgraded, reloading..."),setTimeout((()=>reloadWindow()),3e3))}};PluginSystemLocalManager=__decorateClass([injectable(),__decorateParam(0,inject(TYPES.StorageManager))],PluginSystemLocalManager);const container=new Container;container.bind(TYPES.StorageManager).to(StorageManager).inSingletonScope(),container.bind(TYPES.StorageManagerProvider).toProvider((t=>()=>new Promise((e=>{const n=t.container.get(TYPES.StorageManager);n.initStorage().then((()=>{e(n)}))})))),container.bind(TYPES.PluginSystemLocalManager).to(PluginSystemLocalManager).inSingletonScope(),container.bind(TYPES.PluginSystem).to(PluginSystem).inSingletonScope(),window.pluginSystem||(log("Siyuan Plugin System loading..."),window.pluginSystemVersion=VERSION,window.pluginSystem=container.get(TYPES.PluginSystem).init());
})()